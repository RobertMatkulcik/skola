<!DOCTYPE html>
<html lang=SK>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Funkcie a triggery v procedurálnom jazyku PL/pgSQL. Programovanie na strane databázového servera PostgreSQL.">
<meta property="og:type" content="article">
<meta property="og:title" content="02 PL/pgSQL">
<meta property="og:url" content="http://matkulcik.eu/skola/2017/04/22/PL-pgSQL02/index.html">
<meta property="og:site_name" content="Procedúry a triggery v PostgreSQL">
<meta property="og:description" content="Funkcie a triggery v procedurálnom jazyku PL/pgSQL. Programovanie na strane databázového servera PostgreSQL.">
<meta property="og:updated_time" content="2017-04-27T00:44:17.468Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="02 PL/pgSQL">
<meta name="twitter:description" content="Funkcie a triggery v procedurálnom jazyku PL/pgSQL. Programovanie na strane databázového servera PostgreSQL.">
    
    
        
          
              <link rel="shortcut icon" href="/skola/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/skola/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/skola/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>02 PL/pgSQL</title>
    <!-- styles -->
    <link rel="stylesheet" href="/skola/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/skola/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/skola/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/skola/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/skola/lib/jquery/jquery.min.js"></script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/skola/">Home</a></li>
         
          <li><a href="/skola/tags/teoria">Teória</a></li>
         
          <li><a href="/skola/tags/priklady">Príklady</a></li>
         
          <li><a href="/skola/archives/">Archív</a></li>
         
          <li><a href="https://github.com/RobqFakulcik/skola">Hosted by GitHub</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/skola/2017/04/23/PL-pgSQL-Trigger03/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/skola/2017/04/22/Proc-languages01/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&text=02 PL/pgSQL"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&is_video=false&description=02 PL/pgSQL"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=02 PL/pgSQL&body=Check out this article: http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&name=02 PL/pgSQL&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PL-pgSQL"><span class="toc-number">1.</span> <span class="toc-text">PL/pgSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Doporucenia-pre-navrh-vlozenych-procedur-v-jazyku-PL-pgSQL"><span class="toc-number">1.1.</span> <span class="toc-text">Doporučenia pre návrh vložených procedúr v jazyku PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instalacia-PL-pgSQL"><span class="toc-number">1.2.</span> <span class="toc-text">Inštalácia PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Struktura-funkcie-v-PL-pgSQL"><span class="toc-number">1.3.</span> <span class="toc-text">Štruktúra funkcie v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Priklad-funkcie-v-PL-pgSQL"><span class="toc-number">1.4.</span> <span class="toc-text">Príklad funkcie v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Komentare-v-PL-pgSQL"><span class="toc-number">1.5.</span> <span class="toc-text">Komentáre v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-premennych-v-PL-pgSQL"><span class="toc-number">1.6.</span> <span class="toc-text">Deklarácia premenných v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-parametrov-funkcie"><span class="toc-number">1.7.</span> <span class="toc-text">Deklarácia parametrov funkcie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-atributu-TYPE"><span class="toc-number">1.8.</span> <span class="toc-text">Deklarácia atribútu %TYPE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Udajovy-typ-zaznam-a-riadok-tabulky"><span class="toc-number">1.9.</span> <span class="toc-text">Údajový typ záznam a riadok tabuľky</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vyrazy"><span class="toc-number">1.10.</span> <span class="toc-text">Výrazy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prikaz-priradenia"><span class="toc-number">1.11.</span> <span class="toc-text">Príkaz priradenia</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zavolanie-funkcie-a-jej-navratova-hodnota"><span class="toc-number">1.12.</span> <span class="toc-text">Zavolanie funkcie a jej návratová hodnota</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vyraz-RETURN"><span class="toc-number">1.13.</span> <span class="toc-text">Výraz RETURN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chyby-a-vynimky"><span class="toc-number">1.14.</span> <span class="toc-text">Chyby a výnimky</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vetvenie-programu-a-cykly"><span class="toc-number">1.15.</span> <span class="toc-text">Vetvenie programu a cykly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN"><span class="toc-number">1.16.</span> <span class="toc-text">IF-THEN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN-ELSE"><span class="toc-number">1.17.</span> <span class="toc-text">IF-THEN-ELSE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN-ELSIF"><span class="toc-number">1.18.</span> <span class="toc-text">IF-THEN-ELSIF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CASE"><span class="toc-number">1.19.</span> <span class="toc-text">CASE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-LOOP"><span class="toc-number">1.20.</span> <span class="toc-text">Cyklus LOOP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-WHILE"><span class="toc-number">1.21.</span> <span class="toc-text">Cyklus WHILE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-FOR"><span class="toc-number">1.22.</span> <span class="toc-text">Cyklus FOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zdroje"><span class="toc-number">1.23.</span> <span class="toc-text">Zdroje:</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        
    <h1 class="posttitle" itemprop="name headline">
        02 PL/pgSQL
    </h1>



        <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">
            
            Procedúry a triggery v PostgreSQL
            
        </span>
      </span>
            
    <div class="postdate">
        <time datetime="2017-04-22T17:20:37.000Z" itemprop="datePublished">22-04-2017</time>
    </div>


            
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/skola/tags/teoria/">teoria</a>
    </div>


        </div>
    </header>
    

    <div class="content" itemprop="articleBody">
        <!--Table of content generator-->
        <div id="toc">
            <p>Obsah článku:</p>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PL-pgSQL"><span class="toc-number">1.</span> <span class="toc-text">PL/pgSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Doporucenia-pre-navrh-vlozenych-procedur-v-jazyku-PL-pgSQL"><span class="toc-number">1.1.</span> <span class="toc-text">Doporučenia pre návrh vložených procedúr v jazyku PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instalacia-PL-pgSQL"><span class="toc-number">1.2.</span> <span class="toc-text">Inštalácia PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Struktura-funkcie-v-PL-pgSQL"><span class="toc-number">1.3.</span> <span class="toc-text">Štruktúra funkcie v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Priklad-funkcie-v-PL-pgSQL"><span class="toc-number">1.4.</span> <span class="toc-text">Príklad funkcie v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Komentare-v-PL-pgSQL"><span class="toc-number">1.5.</span> <span class="toc-text">Komentáre v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-premennych-v-PL-pgSQL"><span class="toc-number">1.6.</span> <span class="toc-text">Deklarácia premenných v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-parametrov-funkcie"><span class="toc-number">1.7.</span> <span class="toc-text">Deklarácia parametrov funkcie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-atributu-TYPE"><span class="toc-number">1.8.</span> <span class="toc-text">Deklarácia atribútu %TYPE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Udajovy-typ-zaznam-a-riadok-tabulky"><span class="toc-number">1.9.</span> <span class="toc-text">Údajový typ záznam a riadok tabuľky</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vyrazy"><span class="toc-number">1.10.</span> <span class="toc-text">Výrazy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prikaz-priradenia"><span class="toc-number">1.11.</span> <span class="toc-text">Príkaz priradenia</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zavolanie-funkcie-a-jej-navratova-hodnota"><span class="toc-number">1.12.</span> <span class="toc-text">Zavolanie funkcie a jej návratová hodnota</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vyraz-RETURN"><span class="toc-number">1.13.</span> <span class="toc-text">Výraz RETURN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chyby-a-vynimky"><span class="toc-number">1.14.</span> <span class="toc-text">Chyby a výnimky</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vetvenie-programu-a-cykly"><span class="toc-number">1.15.</span> <span class="toc-text">Vetvenie programu a cykly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN"><span class="toc-number">1.16.</span> <span class="toc-text">IF-THEN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN-ELSE"><span class="toc-number">1.17.</span> <span class="toc-text">IF-THEN-ELSE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN-ELSIF"><span class="toc-number">1.18.</span> <span class="toc-text">IF-THEN-ELSIF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CASE"><span class="toc-number">1.19.</span> <span class="toc-text">CASE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-LOOP"><span class="toc-number">1.20.</span> <span class="toc-text">Cyklus LOOP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-WHILE"><span class="toc-number">1.21.</span> <span class="toc-text">Cyklus WHILE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-FOR"><span class="toc-number">1.22.</span> <span class="toc-text">Cyklus FOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zdroje"><span class="toc-number">1.23.</span> <span class="toc-text">Zdroje:</span></a></li></ol></li></ol>
        </div>
        <h2 id="PL-pgSQL"><a href="#PL-pgSQL" class="headerlink" title="PL/pgSQL"></a>PL/pgSQL</h2><p>V PostgreSQL môžeme PL/pgSQL použiť k implementácií vlastných agregačných aj normálnych funkcií, operátorov, k implementácií procedúr, triggerov. Autori PL/pgSQL sa zjavne inšpirovali staršími verziami programovacieho jazyka PL/SQL, čo je jazyk pre vývoj uložených procedúr firmy Oracle. Nie je tak príliš náročné konvertovať vložené procedúry z ORACLE do PostgreSQL a naopak. PL/SQL je veľmi osekaná ADA rozšírená o SQL. Syntax PL/pgSQL a PL/SQL je veľmi podobná – zásadne sa líši implementácia. PL/pgSQL je veľmi jednoduchý interpret abstraktného syntaktického stromu, ktorý beží v rovnakom procese, v ktorom prebieha spracovanie SQL príkazu. Procedúry PL/SQL bežia vo svojom vlastnom procese, pričom PL/SQL je prekladané do strojového kódu. Každý prístup má svoje výhody a nevýhody – a má samozrejme aj inú motiváciu a iné historické pozadie. PL/pgSQL je úzko integrovaný s PostgreSQL – má zanedbateľnú réžiu, pre prístup k dátam nie je nutné používať interprocess(medzi procesmi) komunikáciu, jednoducho sa udržuje, jednoducho sa rozširuje, jednoducho sa učí. Silou PL/SQL je jeho bohatosť a fakt, že je prekladaný do strojového kódu. Predsa len PL/SQL je menej osekaná ADA než PL/pgSQL a aj vďaka tomu je  univerzálnejší než PL/pgSQL a taktiež náročnejší na naučenie. PL/pgSQL je založený na jednoduchom prekladači (interpreter) – tak jednoduchom, že neimplementuje ani základné aritmetické a logické operácie – každý výraz sa prevádza na SELECT, ktorý spracováva executor. PL/pgSQL obsahuje iba implementáciu premenných a riadiace konštrukcie (IF, LOOP, RETURN, :=, ..). Našťastie jednoduchšie dotazy, ktoré odpovedajú výrazom – t. j. neobsahujú odkaz na tabuľky, dokáže interpret PL/pgSQL spúšťať rádovo efektívnejšie než typické dotazy – t. j. dotazy do tabuliek. Z tejto implementácie vychádza aj efektívne použitie PL/pgSQL. Je to úžasné lepidlo pre SQL príkazy. Na druhú stranu, PL/pgSQL sa vôbec nehodí pre numerické úlohy, ktoré vyžadujú veľký počet aritmetických operácií. PL/pgSQL sa nehodí pre náročnejšie operácie, kde se intenzívne modifikujú reťazce alebo polia. Každá úprava reťazca alebo poľa znamená vytvorenie upravenej kópie pôvodných dát, ktorou sú pôvodné dáta nahradené. Tento prístup je v prípade väčšieho objemu alebo väčšieho počtu operácií neefektívny.<br>V PL/pgSQL sa spojili dva programovacie jazyky – dva interpretované programovacie jazyky – PL/pgSQL a SQL. Pri prvom použití funkcie (v rámci session) sa kód PL/pgSQL prevedie do syntaktického stromu (Abstract Syntax Tree), pri prvom použití SQL príkazu sa generuje prevádzací plán SQL príkazu. Parser PL/pgSQL (rovnako ako PostgreSQL) je postavený nad GNU Bisonom. Získaný syntaktický strom a vytvorené spúšťajúce plány sa používajú opakovane pokiaľ nedôjde k zmene kódu funkcie alebo k ukončení session.</p>
<h3 id="Doporucenia-pre-navrh-vlozenych-procedur-v-jazyku-PL-pgSQL"><a href="#Doporucenia-pre-navrh-vlozenych-procedur-v-jazyku-PL-pgSQL" class="headerlink" title="Doporučenia pre návrh vložených procedúr v jazyku PL/pgSQL"></a>Doporučenia pre návrh vložených procedúr v jazyku PL/pgSQL</h3><p>Na internete je možné nájsť mnoho doporučení pre písanie vložených procedúr v PL/SQL firmy  Oracle. Implementácia PL/pgSQL je iná a totiž nie všetky doporučenia sú relevantné pre PostgreSQL. V PL, rovnako ako v iných programovacích jazykoch, je možné napísať nečitateľný a zle udržiavateľný, poprípade neefektívny kód. Riziko, že Váš kód bude nevyhovujúci, znížime, pokiaľ sa budeme držať následujúcich doporučení:</p>
<ul>
<li>Kód píšeme v klasickom (programátorskom) editore a ukladáme do súboru. V súboroch môžeme lepšie udržovať komentáre, môžeme združovať funkčne blízke alebo závislé funkcie, môžeme verziovať kód. Odporúča sa nepoužívať nástroje ako je pgAdmin alebo phpPgAdmin.</li>
<li>Existujú aj špeciálne IDE pre prácu s databázami napr. DataGrip od firmy JetBrains, či PgExplorer pre platformu Windows.</li>
<li>Namiesto nástroja psql je tiež možné použiť PGCLI. Oproti psql má tento nástroj pomocné funkcie ako Auto Completion alebo zvýrazňovač syntaxe naviac, podporuje viacriadkové príkazy a inteligentnú históriu. Nástroj je naprogramovaný v jazyku Python.</li>
<li>Je potrebné sa brániť pred kolíziou lokálnych premenných a databázových objektov:<ol>
<li>použitím prefixov premenných (napr. pre lokálne premenné symbol “_”)</li>
<li>použitím kvalifikovaných atribútov (tabulka.stlpec) vo všetkých SQL príkazoch v procedúrach</li>
</ol>
</li>
<li>Premenné sa deklarujú pomocou odvodených typov - %TYPE a %ROWTYPE</li>
<li><p>V PL je potrebné používať natívne SQL všade, kde je to možné a rozumné. Pokiaľ by sa naskytla potreba príliš komplikovaného dotazu, je možné, že PL kód bude rýchlejší. Je lepšie nepoužívať dynamické SQL. Častokrát je lepšie cyklus vo funkcií nahradiť klasickým SELECTom obsahujúcim konštrukciu CASE.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">-- neefektívny kód</div><div class="line">IF _cena &lt;= _cena_max THEN</div><div class="line"> 	INSERT INTO tab(id, cena) VALUES(_id, _cena);</div><div class="line">ELSE</div><div class="line">	INSERT INTO tab(id, cena)</div><div class="line">		VALUES(_id, _cena_max);</div><div class="line">END IF;</div><div class="line"></div><div class="line">-- efektívny kód</div><div class="line">INSERT INTO tab(id, cena)</div><div class="line">VALUES(_id, CASE WHEN _cena &lt;= _cena_max</div><div class="line">          		THEN _cena ELSE _cena_max END);</div><div class="line"></div><div class="line">-- neefektívny kód</div><div class="line">FOR _c1, _c2 IN SELECT c1,c2 FROM tab1 LOOP</div><div class="line">	IF _c1 &gt; 20 THEN</div><div class="line">    		INSERT INTO tab2 VALUES(20,_c2);</div><div class="line">  	ELSE</div><div class="line">    		INSERT INTO tab3 VALUES(_c1,_c2);</div><div class="line">  	END IF;</div><div class="line">END LOOP;</div><div class="line"></div><div class="line">-- efektívny kód</div><div class="line">INSERT INTO tab2</div><div class="line">	SELECT 20,c2 FROM tab1 WHERE c1 &gt; 20;</div><div class="line">INSERT INTO tab3</div><div class="line">	SELECT c1,c2 FROM tab1 WHERE c1 &lt;= 20;</div><div class="line"></div><div class="line">-- neefektívny kód</div><div class="line">FOR i IN array_lower(delitems,1) ..</div><div class="line">	array_upper(delitems,1)</div><div class="line">LOOP</div><div class="line">	DELETE FROM tab</div><div class="line">    		WHERE tab.id = delitems[i];</div><div class="line">END LOOP;</div><div class="line"></div><div class="line">-- efektívny kód</div><div class="line">DELETE FROM tab</div><div class="line">	WHERE tab.id = ANY(delitems);</div></pre></td></tr></table></figure>
</li>
<li><p>Funkcia má obsahovať iba jeden príkaz RETURN - jedna cesta dovnútra, jedna cesta von.</p>
</li>
<li>Vyhýbať sa redundantnému kódu - v aplikácií by sa nemal objaviť dvakrát rovnaký kód.</li>
<li><p>Je potrebné využívať funkciu Assert, prípadne jej modifikácie:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> Assert(bool, <span class="built_in">varchar</span>) 			<span class="keyword">RETURNS</span> <span class="built_in">void</span> <span class="keyword">AS</span> $$</div><div class="line">	<span class="keyword">BEGIN</span></div><div class="line">		<span class="keyword">IF</span> <span class="keyword">NOT</span> $<span class="number">1</span> <span class="keyword">OR</span> $<span class="number">1</span> <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">THEN</span></div><div class="line">	   		<span class="keyword">IF</span> $<span class="number">2</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">THEN</span></div><div class="line">	   			<span class="keyword">RAISE</span> <span class="keyword">EXCEPTION</span></div><div class="line">						<span class="string">'Assert failure: %'</span>, $<span class="number">2</span>;</div><div class="line">	   		<span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line">	   		RAISE NOTICE 'Assert. Message is null';</div><div class="line">	 	<span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line">	<span class="keyword">END</span>;</div><div class="line">	$$ LANGUAGE plpgsql;</div><div class="line"></div><div class="line">	<span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> 								Assert_IsNotNull(anyelement, <span class="built_in">varchar</span>)</div><div class="line">	<span class="keyword">RETURNS</span> <span class="built_in">void</span> <span class="keyword">AS</span> $$</div><div class="line">	<span class="keyword">BEGIN</span></div><div class="line">		PERFORM Assert($<span class="number">1</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>, $<span class="number">2</span>);</div><div class="line">	<span class="keyword">END</span>;</div><div class="line">	$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure>
</li>
<li><p>Treba dodržiavať predom dohodnuté notácie pre texty výnimiek, dopredu sa dohodnúť na zozname užívateľom definovaných chyb a chybových hlásení.</p>
</li>
<li>Netestovať na NULL premennú, ktorá je deklarovaná ako NOT NULL. Je na PL, aby zaistil, že tato premenná v žiadnom prípade nebude obsahovať NULL. Pre zaistenie úspešnosti dotazu netestujeme obsah premenných modifikovaných dotazom, ale vždy obsah logickej systémovej premennej FOUND.</li>
<li>Nepoužívať návestie &lt;<label>&gt; pre cykly a bloky, treba využiť typ boolean, tak aby kód bol, čo možno najčitateľnejší.</label></li>
<li>Nespoliehať sa na automatické konverzie typu date a timestamp, ktoré závisia od konfigurácie. Je lepšie použiť funkcie to_char a to_date.</li>
<li>Nepoužiť IF pre naplnenie logickej premennej:<pre><code>is_ok := _age &gt; 18;
</code></pre></li>
<li>Každú premennú treba použiť iba k jednému jasnému účelu. Z kódu treba odstrániť nepoužívané premenné.</li>
<li>Predvolená kategória funkcie je VOLATILE. Pokiaľ v tele funkcie nepristupujete k tabuľkám a nepoužívame funkcie typu random(), currval() atď, je lepšie použiť kategórie IMMUTABLE alebo STABLE. Doba spracovania funkcie môže byť aj o polovicu kratšia.</li>
<li>Nezapuzdrovať SQL príkazy do jednoduchých funkcií.</li>
<li>Obmedzovať použitie kurzorov a dočasných tabuliek.</li>
<li>Je odporúčané preferovať štandardizované funkcie pred vlastnými.</li>
<li>V triggeroch “tajne” neopravujeme dáta, treba posúdiť, či nebude lepšie použiť CHECK.</li>
<li>Každá procedúra by mala obsahovať maximálne 50 až 60 riadkov.</li>
<li>K testovaniu použiť unit testy (k overeniu identifikácie chyby, k overeniu korektnosti opravy)</li>
<li>Zapuzdriť vyvolanie výnimky do vlastnej procedúry.</li>
<li>Vždy vo svojom kóde použiť iba jeden z dvoch možných spôsobov (výnimky a návratový kód) signalizácie chyby.</li>
<li><p>Opakované priradenie do premennej (u typov varchar a array) zlúčiť do jedného výrazu.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--zle</span></div><div class="line"><span class="keyword">DECLARE</span> v <span class="built_in">varchar</span>;</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line"> 	v := <span class="string">'a'</span>;</div><div class="line">  	v := v || 'b';</div><div class="line">  	v := v || 'c';</div><div class="line">  	RETURN v;</div><div class="line"><span class="keyword">END</span>;</div><div class="line"></div><div class="line"><span class="comment">--dobre</span></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">  	<span class="keyword">RETURN</span> <span class="string">'a'</span> || <span class="string">'b'</span> || <span class="string">'c'</span>;</div><div class="line"><span class="keyword">END</span>;</div><div class="line"></div><div class="line"><span class="comment">-- zle</span></div><div class="line"><span class="keyword">DECLARE</span> s <span class="built_in">varchar</span> := <span class="string">''</span>;</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	  <span class="keyword">IF</span> x1 <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">THEN</span></div><div class="line">		    s := s || <span class="string">'NULL,'</span></div><div class="line">	  <span class="keyword">ELSE</span></div><div class="line">		    s := s || x1;</div><div class="line">	  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line">	  IF x2 IS NULL THEN</div><div class="line">		    s := s || 'NULL, '</div><div class="line">	  ELSE</div><div class="line">		    s := s || x2;</div><div class="line">	  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line">	  ...</div><div class="line"></div><div class="line"><span class="comment">-- správne</span></div><div class="line"><span class="keyword">DECLARE</span> s <span class="built_in">varchar</span>;</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	  s := <span class="keyword">COALESCE</span>(x1 || <span class="string">','</span>, <span class="string">'NULL,'</span>)</div><div class="line">	      	 || <span class="keyword">COALESCE</span>(x2 || <span class="string">','</span>, <span class="string">'NULL,'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>Funkcie obsahujúce iba jeden príkaz nepísať v PL/pgSQL, ale v SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--zle</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> foo()</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">varchar</span> <span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	  <span class="keyword">RETURN</span> <span class="string">'a'</span> || <span class="string">'b'</span> || <span class="string">'c'</span>;</div><div class="line"><span class="keyword">END</span>;</div><div class="line">$$ LANGUAGE plpgsql IMMUTABLE;</div><div class="line"></div><div class="line"><span class="comment">--dobre</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> foo()</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">varchar</span> <span class="keyword">AS</span> $$</div><div class="line">	  <span class="keyword">SELECT</span> <span class="string">'a'</span> || <span class="string">'b'</span> || <span class="string">'c'</span>;</div><div class="line">$$ LANGUAGE sql;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Instalacia-PL-pgSQL"><a href="#Instalacia-PL-pgSQL" class="headerlink" title="Inštalácia PL/pgSQL"></a>Inštalácia PL/pgSQL</h3><p>re používanie PL jazykov sa musíme uistiť, či ich máme nainštalované. PostgreSQL podporuje veľa PL jazykov a sľubuje bezproblémový proces ich inštalácie.</p>
<p>Pre inštaláciu PL/pgSQL, stačí spustiť nástroj príkazového riadka a spustiť príkaz:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ createlang plpgsql meno-databazy</div></pre></td></tr></table></figure></p>
<p>PL/pgSQL je však už predvolene nainštalovaný v každej aj novo vytvorenej databáze. Spustenie príkazu vyššie, by malo iba vypísať že PL jazyk už je nainštalovaný.</p>
<p>Predpokladajme, že chceme nainštalovať tento jazyk do testovacej databázy z názvom – test_db. Spustíme teda príkaz (v príklade použitý Linux shell):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ createlang plpgsql test_db</div></pre></td></tr></table></figure></p>
<p>Tento príkaz však predpokladá, že užívateľ operačného systému je rovnaký ako super užívateľ (SuperUser) danej databázy. Pokiaľ nie je, musíme zadať meno super užívateľa databázy za prepínač -U. Príklad:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ createlang plpgsql test_db -U postgres</div></pre></td></tr></table></figure></p>
<h3 id="Struktura-funkcie-v-PL-pgSQL"><a href="#Struktura-funkcie-v-PL-pgSQL" class="headerlink" title="Štruktúra funkcie v PL/pgSQL"></a>Štruktúra funkcie v PL/pgSQL</h3><p>PL/pgSQL má blokovú štruktúru a ide o jazyk citlivý na veľké a malé písmena (ang. case sensitive). Blok obsahuje príkazy vo vnútri kľúčových slov DECLARE /BEGIN a END<br>Blok môže byť definovaný, následovne:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DECLARE</span></div><div class="line">	deklarácia premenných</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	príkazy</div><div class="line"><span class="keyword">END</span>;</div></pre></td></tr></table></figure></p>
<p>Autori popisujú PL ako jazyky blokovo orientované (všetky príkazy sú v nejakom bloku, bloky je možné do seba ľubovoľne vnárať). Blok má zmysel hlavne pri deklarovaní lokálnych premenných. Bloky sa na rozdiel od Pascalu, nepoužívajú k vymedzeniu zoznamu príkazov v konštrukciách IF, WHILE, FOR, LOOP, ale iba k vymedzeniu existencie niektorých lokálnych premenných. Nakoľko bloky hrajú veľkú rolu pri funkciách, máme dostatočné poznatky na vytvorenie funkcie. Začneme teda rozkladať štruktúru funkcie a popisovať element za elementom.<br>Príkaz CREATE FUNCTION používame práve pre vytvorenie funkcií. Ako prvé treba definovať meno funkcie. Ďalej definujeme jej argumenty, návratovú hodnotu a v poslednom rade sekciu deklarácií. Syntax funkcie:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> meno_funkcie (argumenty)</div><div class="line"><span class="keyword">RETURNS</span> <span class="keyword">type</span> <span class="keyword">AS</span></div></pre></td></tr></table></figure></p>
<p>Od verzie 7.2.1 môžeme použiť frázu CREATE OR REPLACE. V predchádzajúcich verziách sa musela funkcia pred jej opakovaným vytvorením daná funkcia zrušiť príkazom DROP FUNCTION. Pretože je možné funkcie preťažovať, musí sa príkazu DROP FUNCTION predať nie len názov funkcie, ale aj typy argumentov, aby podľa nich mohol  PostgreSQL jednoznačne identifikovať správnu verziu funkcie k zmazaniu. Samozrejme funkciu je možné odstrániť iba pokiaľ na to máme práva. Môžeme  zmazať iba užívateľské funkcie (user defined functions), teda funkcie vytvorené pomocou CREATE FUNCTION, nemažeme interné funkcie PostgreSQL. Od verzie 7.3 môžeme určiť, s akými oprávneniami sa bude funkcia vykonávať. Funkcia získa buď práva užívateľa, ktorý funkciu spúšťa (EXTERNAL SECURITY INVOKER), alebo práva vlastníka funkcie (EXTERNAL SECURITY DEFINER). Čiže volajúci – SECURITY INVOKER vlastník – SECURITY DEFINER. Pričom predvolená hodnota každej novo vytvorenej funkcie je SECURITY DEFINER. Kľúčové slovo EXTERNAL je nepovinné.</p>
<p>Vo vnútri bloku, deklarujeme premenné a je možné nastaviť aj predvolenú hodnotu.<br>Blokovú sekciu identifikujeme pomocou kľúčového slova DECLARE. Sekcia sa skladá z mena premennej, údajového typu a končí bodkočiarkou. Každá premenná, riadok alebo záznam použitý vo vnútri bloku, by mala byť deklarovaná v tejto sekcií, výnimkou je cyklus FOR.<br>Čo možno znázorniť nasledujúcim spôsobom:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DECLARE</span></div><div class="line">	deklaracia;</div></pre></td></tr></table></figure></p>
<p>Po definovaní mena funkcie, jej návratového typu a deklarácií premenných, sa zameriame na telo funkcie s kľúčovým slovom BEGIN.<br>Jeho syntax je:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	prikazy;</div></pre></td></tr></table></figure></p>
<p>Sekcia príkazov, môže obsahovať nekonečno pod blokov. Vnorený kód bloku, prečíta interpreter ako obyčajný blok a metóda jeho zápisu je rovnaká ako pri bežnom PL/pgSQL bloku. Inak povedané, sekcia začína slovom DECLARE, nasleduje slovo BEGIN a príkazy vo vnútri tela ukončuje kľúčové slovo END. Je potrebné si zapamätať že BEGIN / END, nespúšťa a ani neukončuje akúkoľvek transakciu, ale slúži na zoskupenie príkazov.<br>Kľúčové slovo END  ukončuje blok kódu:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">END</span>;</div><div class="line">LANGUAGE 'plpgsql';</div></pre></td></tr></table></figure></p>
<p>Hlavné telo PL/pgSQL funkcie, by malo vracať hodnotu predom definovaného typu a všetky pod bloky musia byť riadne uzavreté ešte pred ukončením hlavného bloku.</p>
<h3 id="Priklad-funkcie-v-PL-pgSQL"><a href="#Priklad-funkcie-v-PL-pgSQL" class="headerlink" title="Príklad funkcie v PL/pgSQL"></a>Príklad funkcie v PL/pgSQL</h3><p>Vytvoríme si novú databázu:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">createdb teoria_tst</div></pre></td></tr></table></figure></p>
<p>Jednoduchú skúšobnú tabuľku:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE TABLE tst_tabulka</div><div class="line">(</div><div class="line">	tst_id INTEGER NOT NULL,</div><div class="line">	tst_meno TEXT NOT NULL,</div><div class="line">	rok_narodenia INTEGER,</div><div class="line">	adresa TEXT,</div><div class="line">	mesto CHARACTER VARYING(100),</div><div class="line">	stat CHARACTER VARYING(2),</div><div class="line">	psc CHARACTER VARYING(10),</div><div class="line">	CONSTRAINT "PRIM_KEY" PRIMARY KEY (tst_id)</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>Vložíme dáta do tabuľky:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tst_ tabulka</div><div class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'Rob'</span>, <span class="number">1990</span>, <span class="string">'Vavretánia 240'</span>, <span class="string">'Námestovo'</span>, 	<span class="string">'SK'</span>, <span class="string">'02901'</span>);</div></pre></td></tr></table></figure></p>
<p>Túto databázu budeme používať na väčšinu príkladov v teoretickej časti tejto práce.</p>
<p>Vytvoríme funkciu pocetZaznamov(), ktorá vráti počet zapísaných záznamov do tabuľky tst_tabulka v databáze teoria_tst.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> pocetZaznamov()</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">INTEGER</span> <span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">DECLARE</span></div><div class="line">	pocet <span class="built_in">INTEGER</span>;</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">INTO</span> pocet <span class="keyword">FROM</span> tst_ tabulka;</div><div class="line">RETURN pocet;</div><div class="line"><span class="keyword">END</span>;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Po úspešnom vytvorení, funkciu zavoláme, načo sa vypíše jej návratová hodnota.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT pocetZaznamov();</div><div class="line">pocetZaznamov</div><div class="line">-------------------</div><div class="line">1</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Po pridaní ďalšieho testovacieho riadku do tabuľky, funkcia samozrejme vráti číslo dva a podobne. Takýmto spôsobom vytvárame funkcie v PL/pgSQL.</p>
<h3 id="Komentare-v-PL-pgSQL"><a href="#Komentare-v-PL-pgSQL" class="headerlink" title="Komentáre v PL/pgSQL"></a>Komentáre v PL/pgSQL</h3><p>Pre prehľadnosť kódu je odporúčané používať komentáre, tie je možné používať v PL, tak ako aj v ostatných programovacích jazykoch. Na výber je jednoriadkový komentár a komentár obsahujúci viacero riadkov.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- - jednoriadkový komentár</div><div class="line"></div><div class="line"><span class="comment">/* komentár */</span>  Viac riadkový komentár.</div><div class="line"><span class="comment">/*</span></div><div class="line">Viacriadkový</div><div class="line">komentár</div><div class="line">*/</div></pre></td></tr></table></figure></p>
<p>Nasledujúci príklad funkcie v PL/pgSQL, ukazuje použitie komentárov vo vnútri funkcie. Pričom je vidieť, že komentáre zvyšujú prehľadnosť a hlavne čitateľnosť kódu.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION spojRetazce (text, text)</div><div class="line">--</div><div class="line">--Tato funkcia spoji dva reťazce dokopy</div><div class="line">--</div><div class="line">/* spojovací znak „ || “ (pipe)</div><div class="line">zlúči</div><div class="line">oba retazce*/</div><div class="line">RETURNS text AS $$</div><div class="line">BEGIN</div><div class="line">	RETURN $1 || ' ' || $2;</div><div class="line">END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Použitie funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT spojRetazce('foo', 'bar');</div><div class="line">spojRetazce</div><div class="line">------------</div><div class="line">foo bar</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Deklaracia-premennych-v-PL-pgSQL"><a href="#Deklaracia-premennych-v-PL-pgSQL" class="headerlink" title="Deklarácia premenných v PL/pgSQL"></a>Deklarácia premenných v PL/pgSQL</h3><p>Premenné slúžia na ukladanie dát, aj PL/pgSQL umožňuje použitie premenných. Každá premenná je použiteľná počas doby života bloku, a musí byt deklarovaná vo vnútri bloku DECLARE. Od verzie  PostgreSQL 9.0, nemôže názov premennej byť zároveň kľúčovým slovom v SQL pravdepodobne dôjde k zobrazeniu syntaktickej chyby. V predchádzajúcich verziách sa ako identifikátory premenných nemohli použiť iba kľúčové slová v PL/pgSQL. PostgreSQL čoby databáza nepozná koncept premennej, prípadne lokálnej premennej. Všetká práca s premennými je implementovaná v runtime PL/pgSQL. Každá funkcia získa pri štarte stavovú premennú, ktorá okrem iného obsahuje aj vektor všetkých premenných. Premenné sa očíslujú indexom v tomto vektore - a neskôr pri ich použití sa kopírujú do vektoru parametrov SQL príkazu.<br>Použitie premenných si ukážeme na kóde z funkcie pocetZaznamov():<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> pocetZaznamov()</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">INTEGER</span> <span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">DECLARE</span></div><div class="line">	pocet <span class="built_in">INTEGER</span>;</div></pre></td></tr></table></figure></p>
<p>Pričom vidíme, že pri deklarácií premennej pocet je zvolený údajový typ INTEGER. Čo znamená, že táto premenná dokáže uložiť iba dáta celočíselného typu.<br>Syntax deklarácie premenných:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">meno [ CONSTANT ] typ [ COLLATE znakova_sada ] [ NOT</div><div class="line">NULL ] [ &#123; DEFAULT | := &#125; výraz</div></pre></td></tr></table></figure></p>
<p>Pridanie premennej s kľúčovým slovom CONSTANT, zabezpečí, že hodnota tejto premennej bude konštantná behom spustenia bloku. Slovo COLLATE reprezentuje pravidlá pre usporiadanie reťazcov. Dáta v konkrétnom stĺpci je možné radiť raz podľa slovenských pravidiel COLLATE “sk_sk.utf8”, a druhý raz podľa iných pravidiel (COLLATE “en_US.utf8”). Premenné je možne deklarovať s prednastavenou hodnotou. Pokiaľ táto hodnota nie je nastavená, premennej sa priradí hodnota NULL. Hodnotu je možné nastaviť už v časti DECLARE, pomocou operátora priradenia „ := “. NOT NULL používame v prípade, keď nechceme nastaviť predvolenú hodnotu premennej na NULL. V praxi sa osvedčilo takýmto premenným vždy priradiť hodnotu už pri deklarácií.<br>Do budúcna je dobré si zapamätať, že zakaždým spustením bloku sú vyhodnotené a priradené prednastavené hodnoty premennej. Funkcia func_deklaracia() v nasledujúcej ukážke poukazuje ako zadefinovať konštantu s predvolenou hodnotou „10“. V ukážke tiež vidíme ako deklarovať premennú s NOT NULL a textovú premennú ,do ktorej priradíme hodnotu. 1<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION func_deklaracia()</div><div class="line">RETURNS text AS $$</div><div class="line">DECLARE</div><div class="line">	-- Premenná NOT NULL a priradenie hodnoty</div><div class="line">	 VARCHAR NOT NULL := 'not null text';</div><div class="line">	-- Deklarácia konštanty</div><div class="line">	digit CONSTANT INTEGER := 10;</div><div class="line">	/* Premenná s prednastavenou</div><div class="line">	textovou hodnotou */</div><div class="line">	helloworld VARCHAR DEFAULT 'PostgreSQL rocks !';</div><div class="line">BEGIN</div><div class="line">	RETURN helloworld;</div><div class="line">END;</div><div class="line">$$ LANGUAGE 'plpgsql';</div></pre></td></tr></table></figure></p>
<p>Výpis funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT func_deklaracia();</div><div class="line">func_deklaracia</div><div class="line">--------------------</div><div class="line">PostgreSQL rocks !</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Deklaracia-parametrov-funkcie"><a href="#Deklaracia-parametrov-funkcie" class="headerlink" title="Deklarácia parametrov funkcie"></a>Deklarácia parametrov funkcie</h3><p>Funkcie dokážu prijímať a vracať hodnoty, tieto hodnoty v programovaní nazývame parametre funkcie, či argumenty. Argumenty musia byť deklarované pred ich použitím. Parametre funkcie sú označené numerickým identifikátorom $1 a $2. Tieto symboly $1 a $2 sa používajú vo význame hodnoty prvého a druhého argumentu funkcie. Pre prístup k referenčným hodnotám parametrov, použijeme numerický identifikátor alebo použijeme ALIAS (ang. Prezývka). 1<br>Prezývku – ALIAS priradíme parametru, následujúcim spôsobom:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">meno ALIAS FOR $n;</div></pre></td></tr></table></figure></p>
<p>Použitie v príklade:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> ukazka_alias(<span class="built_in">int</span>)</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">integer</span> <span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">DECLARE</span></div><div class="line">	total <span class="keyword">ALIAS</span> <span class="keyword">FOR</span> $<span class="number">1</span>;</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line"><span class="keyword">RETURN</span> total*<span class="number">10</span>;</div><div class="line"><span class="keyword">END</span>;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Bežne však definujeme meno parametra už v príkaze CREATE FUNCTION:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> ukazka_alias(total <span class="built_in">int</span>)</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">integer</span> <span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	<span class="keyword">RETURN</span> total*<span class="number">10</span>;</div><div class="line"><span class="keyword">END</span>;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Funkcia po jej použití, vráti:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT ukazka_alias(10);</div><div class="line">ukazka_alias</div><div class="line">---------------</div><div class="line">100</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Parametru funkcie je možné nastaviť aj typ. Poznáme tri typy parametrov: IN, OUT, INOUT. Funkcia deklarovaná s parametrom typu IN obsahuje hodnotu, ktorá bude odovzdaná funkcií. Pokiaľ nedeklarujeme typ parametra, bude ním predvolene IN. Typ OUT sa vráti ako výsledok funkcie. Obe typy sú efektívne, pokiaľ má funkcia vrátiť viacero výstupov bez deklarácie výstupu typu PostgreSQL. Parameter typu INOUT slúži obom spomínaným účelom. Ide teda parameter pre vstup a aj výstup funkcie. 2<br>Následujúca funkcia používa IN a OUT parametre:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION func_parametre(a int, IN b</div><div class="line">int, OUT plus int, OUT minus int) AS $$</div><div class="line">BEGIN</div><div class="line">	plus := a + b;</div><div class="line">	minus := a - b;</div><div class="line">END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Použitie funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT func_parametre(10, 5);</div><div class="line">func_parametre</div><div class="line">------------</div><div class="line">(15,5)</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Deklaracia-atributu-TYPE"><a href="#Deklaracia-atributu-TYPE" class="headerlink" title="Deklarácia atribútu %TYPE"></a>Deklarácia atribútu %TYPE</h3><p>Atribút %TYPE používame pri ukladaní hodnôt z databázového objektu, zvyčajne stĺpca tabuľky. Premenná s týmto atribútom ukladá hodnotu rovnakého údajového typu ako tá, na ktorú odkazuje. Čo je  nápomocné hlavne pri budúcej zmene údajového typu stĺpca.<br>Deklarácia:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">meno_premennej meno_tabulky.meno_stlpca%TYPE</div></pre></td></tr></table></figure></p>
<p>Naša databáza teoria_tst obsahuje stĺpec rok_narodenia v tabuľke tst_tabulka. Premennú odkazujúcu na tento stĺpec deklarujeme, takto:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rok tst_tabulka.rok_narodenia%TYPE</div></pre></td></tr></table></figure></p>
<h3 id="Udajovy-typ-zaznam-a-riadok-tabulky"><a href="#Udajovy-typ-zaznam-a-riadok-tabulky" class="headerlink" title="Údajový typ záznam a riadok tabuľky"></a>Údajový typ záznam a riadok tabuľky</h3><p>Premenná typu riadok sa deklaruje na používateľom definovanej tabuľke alebo pohľade použitím príkazu meno_tabulky%ROWTYPE. K jednotlivým riadkom je možné pristupovať bodkovou notáciou, napríklad – riadok.pole . Premenná deklarovaná ako typ ROWTYPE dokáže uložiť riadok z výsledku dotazu SELECT alebo FOR. Typ záznam (RECORD) je podobný ROWTYPE s výnimkou, že nemá žiadnu preddefinovanú štruktúru a  dokáže akceptovať riadky z ktorejkoľvek tabuľky. Čo znamená, že je možné zmeniť štruktúru za každým pripojením na riadok. Ide o konštrukciu pre iteráciu naprieč množinou záznamov špecifikovanou príkazom SELECT či FOR.</p>
<h3 id="Vyrazy"><a href="#Vyrazy" class="headerlink" title="Výrazy"></a>Výrazy</h3><p>Výrazy používame v procedurálnom programovaní kedykoľvek chceme priradiť hodnotu k premennej, zavolať funkciu alebo použiť podmienený výraz ako je IF a ELSE. Poradie spustenia výrazov, kontrolujeme ich organizáciou. Každý výraz je zakončený bodkočiarkou.</p>
<h3 id="Prikaz-priradenia"><a href="#Prikaz-priradenia" class="headerlink" title="Príkaz priradenia"></a>Príkaz priradenia</h3><p>Ide o najčastejšie používaný príkaz. Priraďujeme nim premenenej svoju hodnotu.<br>Syntax príkazu:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ciel := hodnota;</div></pre></td></tr></table></figure></p>
<p>Kde , cieľ môže byt čokoľvek, premenná, stĺpec, parameter funkcie, riadok, ale nie konštanta. Počas spustenia, sa zo všetkých operácii prednostne priradia hodnoty do premenných. Pokiaľ sa typ premennej a hodnota nezhodujú, PostgreSQL sa hodnotu pokúsi konvertovať alebo vypíše chybu.</p>
<h3 id="Zavolanie-funkcie-a-jej-navratova-hodnota"><a href="#Zavolanie-funkcie-a-jej-navratova-hodnota" class="headerlink" title="Zavolanie funkcie a jej návratová hodnota"></a>Zavolanie funkcie a jej návratová hodnota</h3><p>Všetky PostgreSQL funkcie vracajú hodnotu. Vytvorenú funkciu spustíme jednoducho príkazom SELECT.<br>Niekoľko názorných príkladov:</p>
<ul>
<li><p>The SELECT  identifikator_funkcie() fukcia:</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> identifikator(argumenty);</div></pre></td></tr></table></figure>
</li>
<li><p>Priradenie prednastavenej hodnoty funkcií identifikator_funkcie():</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">identifikator_premennej:=identifikator(argumenty);</div></pre></td></tr></table></figure>
</li>
<li><p>Príkaz SELECT a AVG(riadok) funkcia:</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">AVG</span>(tst_id) <span class="keyword">FROM</span> tst_tabulka;</div></pre></td></tr></table></figure>
</li>
<li><p>Príkaz SELECT a funkcia pocetZaznamov():</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> pocetZaznamov();</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Vyraz-RETURN"><a href="#Vyraz-RETURN" class="headerlink" title="Výraz RETURN"></a>Výraz RETURN</h3><p>Pokiaľ funkcia úspešne skončí, vyhodnotí sa hodnota výrazu, ktorá bude mať návratovú hodnotu a to takého typu ako je špecifikované v príkaze CREATE FUNCTION.<br>Syntax príkazu RETURN je nasledujúca:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">CREATE OR REPLACE FUNCTION 		identifikator_funkcie(argumenty)</div><div class="line">RETURNS TYPE AS</div><div class="line">DECLARE</div><div class="line">	deklaracna_cast;</div><div class="line">BEGIN</div><div class="line">výrazy;</div><div class="line">RETURN &#123; meno_premennej | hodnota&#125;</div><div class="line">END;</div><div class="line">LANGUAGE 'plpgsql;</div></pre></td></tr></table></figure></p>
<h3 id="Chyby-a-vynimky"><a href="#Chyby-a-vynimky" class="headerlink" title="Chyby a výnimky"></a>Chyby a výnimky</h3><p>Pokiaľ dôjde  k chybe v syntaxe alebo výnimke, beh programu skončí chybovým hlásením. Vyvolané výnimky je však možné zachytiť. Pre odchyt takejto výnimky implementujeme do funkcie programu príkaz RAISE.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RAISE NOTICE ''Pokus o delenie nulou'';</div></pre></td></tr></table></figure></p>
<p>Prvým argumentom príkazu RAISE je úroveň výnimky. K dispozícii sú tri možnosti: DEBUG – zapíše sa do logu, NOTICE – oznámi sa užívateľovi, EXCEPTION – preruší sa vykonávanie funkcie. Druhým parametrom je text chybového hlásenia (text zapisujeme medzi zdvojené apostrofy). Pokiaľ sa v texte objaví symbol %, potom sa tento symbol nahradí odpovedajúcou premennou, ktorá se predá ako tretí, štvrtý, atď. argument. V PL/pgSQL nie je možné zachytiť výnimku, t. j. každá výnimka na úrovni EXCEPTION vedie k prerušeniu chodu funkcie. RAISE NOTICE sa bežne používa pre zobrazenie ladiacich hlásení, zobrazeniu obsahu premenných. V podstate je to jediný ladiaci prostriedok, ktorý je k dispozícii. RAISE DEBUG prepošle špecifikovaný text ako odlaďovaciu správu do PostgreSQL logu a klientského programu, pokiaľ je klient pripojený do databázového clustra so spustením módu debug. DEBUG je v produkčnom móde ignorovaný. RAISE EXCEPTION pošle špecifický text ako správu o chybe klientskému programu a PostreSQL logu. Tiež prerušuje prebiehajúci chod funkcie. 1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> raise_test () <span class="keyword">RETURNS</span> <span class="built_in">integer</span> <span class="keyword">AS</span> <span class="string">'</span></div><div class="line">  DECLARE</div><div class="line">   		cislo INTEGER = 1;</div><div class="line"> 	BEGIN</div><div class="line"> 	  	 -- Raise debug správa.</div><div class="line"> 	  	RAISE DEBUG ''Raise_test() funkcia začala.'';</div><div class="line">   		cislo = cislo + 1;</div><div class="line">   		 -- Raise notice poukazuje</div><div class="line">	 -- na zmenu premennej - cislo</div><div class="line">   		RAISE NOTICE</div><div class="line">		''Hodnota premennej cislo bola pozmenená.'';</div><div class="line">	 -- Vypise sa nova hodnota premennej</div><div class="line">   		RAISE NOTICE</div><div class="line">		''Nova hodnota premennej je: %.'',cislo;</div><div class="line">   		 -- Raise exception.</div><div class="line">   		RAISE EXCEPTION</div><div class="line">		''Hodnota % sa zmenila.</div><div class="line">			Funkcia prerušená.'',cislo;</div><div class="line">   		RETURN 1;</div><div class="line"> 	END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Výsledok po spustení funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">teroria_tst=# SELECT raise_test();</div><div class="line">NOTICE:   Hodnota premennej cislo bola pozmenená</div><div class="line">NOTICE:   Nova hodnota premennej je: 2</div><div class="line">ERROR:    Hodnota 2 sa zmenila.  Funkcia prerušená.</div></pre></td></tr></table></figure></p>
<p>Výstup DEBUG sa nezobrazil, pretože databáza neprebieha v mode debuging.</p>
<p>Lepším príkladom pre RAISE EXCEPTION bude následujúci príklad, ktorý kontroluje správnosť poštového smerovacie čísla.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">CREATE OR REPLACE FUNCTION validacia_sk_PSC(psc TEXT)</div><div class="line">	RETURNS boolean AS $$</div><div class="line">	DECLARE</div><div class="line">		cisla text;</div><div class="line">	BEGIN</div><div class="line">		-- REGEX zmaze vsetko co nie je cislo</div><div class="line">		cisla := (SELECT regexp_replace</div><div class="line">		(psc,'[^[:digit:]]','','g'));</div><div class="line">		IF cisla = '' THEN</div><div class="line">			RAISE EXCEPTION</div><div class="line">		'PSC neobsahuje ziadne cisla	--&gt; %', cisla</div><div class="line">			USING HINT = 'Jedná sa o Slovenské PSČ?',</div><div class="line">			ERRCODE = 'P9999';</div><div class="line">		ELSIF length(cisla) &lt; 5 THEN</div><div class="line">			RAISE EXCEPTION</div><div class="line">			'PSČ neobsahuje dostatočný počet číslic</div><div class="line">			--&gt; %', cisla</div><div class="line">			USING HINT = 'PSČ má menej než 5 číslic',</div><div class="line">			ERRCODE = 'P9998';</div><div class="line">		ELSIF length(cisla) &gt; 9 THEN</div><div class="line">			RAISE EXCEPTION</div><div class="line">			'Zbytočne veľa číslic --&gt; %', cisla</div><div class="line">			USING HINT =</div><div class="line">			'PSČ obsahuje viac než 9 číslic.',</div><div class="line">			ERRCODE = 'P9997';</div><div class="line">		ELSIF length(cisla) &gt; 5 AND length(cisla) &lt; 9 				THEN</div><div class="line">			RAISE EXCEPTION</div><div class="line">				'PSČ nie je validné --&gt; %', cisla</div><div class="line">			USING HINT =</div><div class="line">			'PSČ ma abnormálny počet číslic	.',</div><div class="line">			ERRCODE = 'P9996';</div><div class="line">		ELSE</div><div class="line">			RETURN true;</div><div class="line">		END IF;</div><div class="line">	END;</div><div class="line">	$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Každej výnimke môžeme priradiť špeciálnu ERRCODE hodnotu. Jej horná hranica je P9999, hodnota symbolizuje typ danej chyby. Ide o veľmi zjednodušený postup a je odporúčané neprekrývať chybové kódy definované v PL/pgSQL(napr. P0001).<br>Následujúci príklad funkcie zachytáva chyby, vytvorené v predchádzajúcej funkcii:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> ziskaj_SK_stav_validacie_PSC(psc <span class="built_in">TEXT</span>)</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">TEXT</span> <span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line"> 	 <span class="comment">-- Perform je ako SELECT</span></div><div class="line">	 <span class="comment">-- ibaze vrati iba jeden riadok napr. True</span></div><div class="line"> 	PERFORM validacia_sk_PSC(psc);</div><div class="line"> 	RETURN 'PSČ je validne.';</div><div class="line">  	EXCEPTION</div><div class="line">  	WHEN SQLSTATE 'P9999'</div><div class="line">    		THEN RETURN 'Nejedna sa o SK PSC.';</div><div class="line">  	WHEN SQLSTATE 'P9998'</div><div class="line">  		THEN RETURN 'Malo cislic.';</div><div class="line">  	WHEN SQLSTATE 'P9997'</div><div class="line">    		THEN RETURN 'Privela cislic.';</div><div class="line">  	WHEN SQLSTATE 'P9996'</div><div class="line">    		THEN RETURN 'Dlzka cisla medzi 6 - 8 cislic.';</div><div class="line">      	RAISE; <span class="comment">-- Iná SQL chyba...</span></div><div class="line"><span class="keyword">END</span>;</div><div class="line">$$</div><div class="line">LANGUAGE 'plpgsql';</div></pre></td></tr></table></figure></p>
<p>Výsledok funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT ziskaj_SK_stav_validacie_PSC('34955');</div><div class="line"></div><div class="line">ziskaj_SK_stav_validacie_PSC</div><div class="line">------------------------------</div><div class="line">PSČ je validne.</div><div class="line">(1 row)</div><div class="line"></div><div class="line">teoria_tst=# SELECT ziskaj_SK_stav_validacie_PSC('349587');</div><div class="line"></div><div class="line">ziskaj_SK_stav_validacie_PSC</div><div class="line">------------------------------</div><div class="line">Dlzka cisla medzi 6 - 8 cislic.</div><div class="line">(1 row)</div><div class="line"></div><div class="line">teoria_tst=# SELECT ziskaj_SK_stav_validacie_PSC('3495878977');</div><div class="line"></div><div class="line">ziskaj_SK_stav_validacie_PSC</div><div class="line">------------------------------</div><div class="line">Privela cislic.</div><div class="line">(1 row)</div><div class="line"></div><div class="line">teoria_tst=# SELECT ziskaj_SK_stav_validacie_PSC('BNHCGR');</div><div class="line"></div><div class="line">ziskaj_SK_stav_validacie_PSC</div><div class="line">------------------------------</div><div class="line">Nejedna sa o SK PSC.</div><div class="line">(1 row)</div><div class="line">teoria_tst=# SELECT ziskaj_SK_stav_validacie_PSC('3467');</div><div class="line"></div><div class="line">ziskaj_SK_stav_validacie_PSC</div><div class="line">------------------------------</div><div class="line">Malo cislic.</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Vetvenie-programu-a-cykly"><a href="#Vetvenie-programu-a-cykly" class="headerlink" title="Vetvenie programu a cykly"></a>Vetvenie programu a cykly</h3><p>Štruktúra podmienených výrazov a cyklov obsahuje príkazy, ktoré sa vykonajú po splnení podmienky.<br>Syntax pre podmienené výrazy:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">IF podmienka THEN</div><div class="line">	príkazy</div><div class="line">ELSE</div><div class="line">	príkazy</div><div class="line"><span class="keyword">END</span> <span class="keyword">IF</span>;</div></pre></td></tr></table></figure></p>
<p> Syntax pre príkaz cyklu:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">LOOP</div><div class="line">	príkazy</div><div class="line"><span class="keyword">END</span> <span class="keyword">LOOP</span>;</div></pre></td></tr></table></figure></p>
<h3 id="IF-THEN"><a href="#IF-THEN" class="headerlink" title="IF-THEN"></a>IF-THEN</h3><p>Najjednoduchšia forma podmieneného výrazu. Syntax príkazu IF-THEN:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">IF boolean-podmienka THEN</div><div class="line">	príkazy</div><div class="line"><span class="keyword">END</span> <span class="keyword">IF</span>;</div></pre></td></tr></table></figure></p>
<p>Spustenie príkazov medzi blokom THEN a END závisí od splnenia booleovskej podmienky. Pokiaľ sa teda podmienka  splní, pričom jej hodnota bude TRUE, príkazy sa vykonajú. Inak bude blok kódu ignorovaný.<br>Nasledujúci príklad, poukazuje na jeden z mnohých prípadov použitia IF-THEN:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">IF tst_id &gt; 2 THEN</div><div class="line">	UPDATE tst_tabulka</div><div class="line">	SET mesto='Vavrečka'</div><div class="line">	WHERE</div></pre></td></tr></table></figure></p>
<h3 id="IF-THEN-ELSE"><a href="#IF-THEN-ELSE" class="headerlink" title="IF-THEN-ELSE"></a>IF-THEN-ELSE</h3><p>V niektorých situáciách je potrebné zdôrazniť, ktoré príkazy se majú spustiť v prípade, že podmienka nie je splnená. V takom prípade pridáme sekciu ELSE (inak). Táto sekcia je nepovinná a nachádza sa vždy na konci výrazu IF. 1 Syntax je následujúca:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">IF boolean-podmienka THEN</div><div class="line">	príkazy</div><div class="line">ELSE</div><div class="line">	príkazy;</div><div class="line"><span class="keyword">END</span> <span class="keyword">IF</span>;</div></pre></td></tr></table></figure></p>
<p>Modifikujeme funkciu pocetZaznamov(), a použijeme blok IF-THEN-ELSE.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION pocetZaznamov()</div><div class="line">RETURNS INTEGER AS $$</div><div class="line">DECLARE</div><div class="line">	pocet INTEGER;</div><div class="line">BEGIN</div><div class="line">	SELECT COUNT(*) INTO pocet FROM tst_tabulka;</div><div class="line">	IF (pocet &gt; 0) THEN</div><div class="line">		RETURN pocet;</div><div class="line">	ELSE</div><div class="line">		RAISE NOTICE 'Tabuľka je prázdna';</div><div class="line">	END IF;</div><div class="line">END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Spustenie funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT pocetZaznamov();</div><div class="line">pocetZaznamov</div><div class="line">------------</div><div class="line">3</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="IF-THEN-ELSIF"><a href="#IF-THEN-ELSIF" class="headerlink" title="IF-THEN-ELSIF"></a>IF-THEN-ELSIF</h3><p>Niektoré prípady vyžadujú viac ako dve vetvy programu, vtedy použijeme IF-THEN-ELSIF. Pokiaľ sa podmienka IF nesplní, príkazy sa ignorujú a vyhodnotí sa podmienený výraz ELSIF. Pokiaľ je pravdivý, spustia sa príkazy vo vnútri bloku.<br>Príkaz ELSIF najlepšie pochopíme použitím v príklade:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION vnorenie_if(body integer)</div><div class="line">RETURNS text AS $$</div><div class="line">DECLARE</div><div class="line">	stav text;</div><div class="line">BEGIN</div><div class="line">	IF body &gt; 33 THEN</div><div class="line">	znamka := 'PRESIEL';</div><div class="line">	RETURN znamka;</div><div class="line">ELSIF body = 33 THEN</div><div class="line">	znamka := 'PRIEMER' ;</div><div class="line">	RETURN znamka;</div><div class="line">ELSIF body &lt; 33 THEN</div><div class="line">	znamka := 'NEPRESIEL';</div><div class="line">	RETURN znamka;</div><div class="line">ELSE</div><div class="line">	-- pokial nastane NULL, ziak nebol na skuske</div><div class="line">	stav := 'Nedostavil sa na skusku';</div><div class="line">	RETURN stav;</div><div class="line">END IF;</div><div class="line">END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Výsledok pri dosiahnutí 33 bodov z testu:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT vnorenie_if(33);</div><div class="line">vnorenie_if</div><div class="line">---------</div><div class="line">PRIEMER</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Výsledok pri dosiahnutí 32 bodov z testu:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT vnorenie_if(32);</div><div class="line">vnorenie_if</div><div class="line">---------</div><div class="line"> NEPRESIEL</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Výsledok pri dosiahnutí 34 bodov z testu:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT vnorenie_if(34);</div><div class="line">vnorenie_if</div><div class="line">---------</div><div class="line"> PRESIEL</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Výsledok pokiaľ sa žiak nezúčastnil na teste:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT vnorenie_if(null);</div><div class="line">vnorenie_if</div><div class="line">---------</div><div class="line">Nedostavil sa na skusku</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="CASE"><a href="#CASE" class="headerlink" title="CASE"></a>CASE</h3><p>Direktíva vždy začína kľúčovým slovom CASE, vždy končí kľúčovým slovom END a vždy má aspoň jednu WHEN-THEN časť. Podmienka CONDITION sa vyhodnotí ako booleovský výraz (pravda alebo nepravda). Pokiaľ je pravda, výsledkom celého CASE je vyraz. Pokiaľ je nepravda, skúsi sa to v ďalšej WHEN-THEN časti. Pokiaľ nie je splnená žiadna CONDITION, výsledkom je výraz za ELSE. Pokiaľ nie je ELSE vyraz definovaný, tak už ostáva ako výsledok iba NULL.1<br>Syntax:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CASE</div><div class="line">WHEN podmienka_boolean THEN</div><div class="line">	Výrazy</div><div class="line"><span class="keyword">END</span> <span class="keyword">CASE</span>;</div></pre></td></tr></table></figure></p>
<p>Vytvoríme novú funkciu, ktorá obsahuje direktívu CASE:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">CREATE OR REPLACE FUNCTION podmienka_case(body integer)</div><div class="line">RETURNS text AS $$</div><div class="line">DECLARE</div><div class="line">	znamka text;</div><div class="line">BEGIN</div><div class="line">	CASE</div><div class="line">		WHEN body &gt;= 40 THEN</div><div class="line">			znamka := 'PRESIEL';</div><div class="line">			RETURN znamka;</div><div class="line">		WHEN body &lt;= 39 AND body &gt; 0 THEN</div><div class="line">			znamka := 'NEPRESIEL';</div><div class="line">			RETURN znamka;</div><div class="line">		ELSE</div><div class="line">			znamka := 'Nedostavil sa na skusku';</div><div class="line">			RETURN znamka;</div><div class="line">	END CASE;</div><div class="line">END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Výsledok pri dosiahnutí 30 bodov z testu:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT podmienka_case(30);</div><div class="line">podmienka_case</div><div class="line">-------------</div><div class="line">NEPRESIEL</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Výsledok pri dosiahnutí 30 bodov z testu:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT podmienka_case(40);</div><div class="line">podmienka_case</div><div class="line">-------------</div><div class="line">PRESIEL</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Cyklus-LOOP"><a href="#Cyklus-LOOP" class="headerlink" title="Cyklus LOOP"></a>Cyklus LOOP</h3><p>Zrejme nemôže existovať programovací jazyk bez konštrukcií cyklu. PL/pgSQL nie je výnimkou, obsahuje dokonca štyri rôzne konštrukcie: cyklus FOR IN interval pre prevedenie predom známeho počtu cyklov, cyklus FOR IN SELECT pre iteráciu cez všetky riadky výsledku SQL dotazu, a cykly LOOP a WHILE pre prevedenie dopredu neznámeho počtu iterácií príkazov. Prevedenie cyklu môžeme v všetkých štyroch prípadoch prerušiť príkazom EXIT [návestie][WHEN logický_výraz].<br>Syntax:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LOOP</div><div class="line">	vysledok= vysledok -1</div><div class="line">EXIT WHEN vysledok &gt; 0;</div><div class="line">END LOOP;</div></pre></td></tr></table></figure></p>
<p>Cyklus implementujeme do novej PL/pgSQL funkcie, ktorá žiada číslo ako vstupný parameter. Toto číslo budeme v cykle násobiť známkou 10. Cyklus bude bežať pokiaľ hodnota známky nebude rovná alebo väčšia ako 100. 1<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION cyklus_loop(cislo integer)</div><div class="line">RETURNS integer AS $$</div><div class="line">DECLARE</div><div class="line">	znamka integer := 10;</div><div class="line">BEGIN</div><div class="line">	LOOP</div><div class="line">		znamka := znamka * znamka;</div><div class="line">		IF (grade &gt;= 100) THEN</div><div class="line">			EXIT;</div><div class="line">		END IF;</div><div class="line">	END LOOP;</div><div class="line">	RETURN znamka;</div><div class="line">END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Spustenie a výsledok funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT cyklus_loop(10);</div><div class="line">cyklus_loop</div><div class="line">-------------</div><div class="line">100</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Cyklus-WHILE"><a href="#Cyklus-WHILE" class="headerlink" title="Cyklus WHILE"></a>Cyklus WHILE</h3><p>Cyklus WHILE-END WHILE zaistí opakované spúšťanie bloku SQL príkazov v prípade, že zadaný výraz je pravdivý. V prípade, že výraz je neplatný už pri zahájení príkazu, telo cyklu sa nespustí ani raz. Tento cyklus je podobný cyklu REPEAT-UNTIL, ktorý zaistí minimálne jedno vyhodnotenie tela cyklu.<br>Syntax:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">WHILE podmienka_boolean</div><div class="line">LOOP</div><div class="line">	výrazy</div><div class="line"><span class="keyword">END</span> <span class="keyword">LOOP</span>;</div></pre></td></tr></table></figure></p>
<p>Ukážka obsahuje funkciu pre výpočet faktoriálu:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> faktorial(n <span class="built_in">INT</span>)</div><div class="line">	<span class="keyword">RETURNS</span> <span class="built_in">INT</span> <span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">DECLARE</span></div><div class="line">  	f <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</div><div class="line">  	pocitadlo INTEGER = n;</div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	<span class="keyword">WHILE</span> pocitadlo &gt; <span class="number">1</span></div><div class="line">	<span class="keyword">LOOP</span></div><div class="line">		f := f * pocitadlo;</div><div class="line"> 		pocitadlo := pocitadlo - 1;</div><div class="line"> 	<span class="keyword">END</span> <span class="keyword">LOOP</span>;</div><div class="line"> 	RETURN f;</div><div class="line"><span class="keyword">END</span>;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Spustenie funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT cyklus_while(5);</div><div class="line">cyklus_while</div><div class="line">------------</div><div class="line">250</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Cyklus-FOR"><a href="#Cyklus-FOR" class="headerlink" title="Cyklus FOR"></a>Cyklus FOR</h3><p>Ide o najčastejšie používaný druh cyklu. Tento druh cyklu pracuje vo vopred danom rozsahu hodnoty typu integer. Premennú s touto hodnotou nemusíme deklarovať v bloku DECLARE. Životnosť takejto premennej zaniká ukončením cyklu FOR. Verzia PostgreSQL 9.1 bola rozšírená o cyklus FOREACH – iteráciu nad poľom s možnosťou iterácií po riadkoch. 1<br>Syntax cyklu FOR:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FOR i in 1...10</div><div class="line">LOOP</div><div class="line">	výrazy</div><div class="line"><span class="keyword">END</span> <span class="keyword">LOOP</span>;</div></pre></td></tr></table></figure></p>
<p>Použitie cyklu FOR:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION 		cyklus_for(hodnota integer)</div><div class="line">RETURNS integer AS $$</div><div class="line">DECLARE</div><div class="line">znamka integer := 2;</div><div class="line">BEGIN</div><div class="line">	FOR i IN 1..10</div><div class="line">	LOOP</div><div class="line">		znamka := znamka * hodnota;</div><div class="line">END LOOP;</div><div class="line">RETURN znamka;</div><div class="line">END;</div><div class="line">$$ LANGUAGE plpgsql;</div></pre></td></tr></table></figure></p>
<p>Spustenie funkcie:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT cyklus_for(2);</div><div class="line">cyklus_for</div><div class="line">----------------</div><div class="line">2048</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Cyklus FOR je možné použiť spolu s DML (Data Manipulation Language) príkazom SELECT a to pomocou kľúčového slova EXECUTE.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION</div><div class="line">cyklus_for_a_select(dotaz VARCHAR)</div><div class="line">RETURNS integer AS $$</div><div class="line">DECLARE</div><div class="line">	pocet integer := 0;</div><div class="line">	zaznam_tabulky RECORD;</div><div class="line">BEGIN</div><div class="line">	FOR zaznam_tabulky IN EXECUTE dotaz</div><div class="line">	LOOP</div><div class="line">		pocet := pocet + 1;</div><div class="line">	END LOOP;</div><div class="line">	RETURN pocet;</div><div class="line">END;</div><div class="line">$$ LANGUAGE 'plpgsql;</div></pre></td></tr></table></figure></p>
<p>Po spustení funkcie spolu s SELECT dotazom ako parametrom funkcie. Bude výsledok takejto funkcie  počet riadkov v tabuľke.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT</div><div class="line">cyklus_for_a_select('SELECT * FROM tst_tabulka');</div><div class="line">cyklus_for_a_select</div><div class="line">----------------</div><div class="line">2</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Zdroje"><a href="#Zdroje" class="headerlink" title="Zdroje:"></a>Zdroje:</h3><p><a href="https://www.root.cz/clanky/efektivni-pouzivani-pl-pgsql/" target="_blank" rel="external">https://www.root.cz/clanky/efektivni-pouzivani-pl-pgsql/</a><br><a href="http://postgres.cz/wiki/PL/pgSQL" target="_blank" rel="external">http://postgres.cz/wiki/PL/pgSQL</a>;</p>

    </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/skola/">Home</a></li>
         
          <li><a href="/skola/tags/teoria">Teória</a></li>
         
          <li><a href="/skola/tags/priklady">Príklady</a></li>
         
          <li><a href="/skola/archives/">Archív</a></li>
         
          <li><a href="https://github.com/RobqFakulcik/skola">Hosted by GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PL-pgSQL"><span class="toc-number">1.</span> <span class="toc-text">PL/pgSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Doporucenia-pre-navrh-vlozenych-procedur-v-jazyku-PL-pgSQL"><span class="toc-number">1.1.</span> <span class="toc-text">Doporučenia pre návrh vložených procedúr v jazyku PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instalacia-PL-pgSQL"><span class="toc-number">1.2.</span> <span class="toc-text">Inštalácia PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Struktura-funkcie-v-PL-pgSQL"><span class="toc-number">1.3.</span> <span class="toc-text">Štruktúra funkcie v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Priklad-funkcie-v-PL-pgSQL"><span class="toc-number">1.4.</span> <span class="toc-text">Príklad funkcie v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Komentare-v-PL-pgSQL"><span class="toc-number">1.5.</span> <span class="toc-text">Komentáre v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-premennych-v-PL-pgSQL"><span class="toc-number">1.6.</span> <span class="toc-text">Deklarácia premenných v PL/pgSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-parametrov-funkcie"><span class="toc-number">1.7.</span> <span class="toc-text">Deklarácia parametrov funkcie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deklaracia-atributu-TYPE"><span class="toc-number">1.8.</span> <span class="toc-text">Deklarácia atribútu %TYPE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Udajovy-typ-zaznam-a-riadok-tabulky"><span class="toc-number">1.9.</span> <span class="toc-text">Údajový typ záznam a riadok tabuľky</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vyrazy"><span class="toc-number">1.10.</span> <span class="toc-text">Výrazy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prikaz-priradenia"><span class="toc-number">1.11.</span> <span class="toc-text">Príkaz priradenia</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zavolanie-funkcie-a-jej-navratova-hodnota"><span class="toc-number">1.12.</span> <span class="toc-text">Zavolanie funkcie a jej návratová hodnota</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vyraz-RETURN"><span class="toc-number">1.13.</span> <span class="toc-text">Výraz RETURN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chyby-a-vynimky"><span class="toc-number">1.14.</span> <span class="toc-text">Chyby a výnimky</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vetvenie-programu-a-cykly"><span class="toc-number">1.15.</span> <span class="toc-text">Vetvenie programu a cykly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN"><span class="toc-number">1.16.</span> <span class="toc-text">IF-THEN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN-ELSE"><span class="toc-number">1.17.</span> <span class="toc-text">IF-THEN-ELSE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IF-THEN-ELSIF"><span class="toc-number">1.18.</span> <span class="toc-text">IF-THEN-ELSIF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CASE"><span class="toc-number">1.19.</span> <span class="toc-text">CASE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-LOOP"><span class="toc-number">1.20.</span> <span class="toc-text">Cyklus LOOP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-WHILE"><span class="toc-number">1.21.</span> <span class="toc-text">Cyklus WHILE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cyklus-FOR"><span class="toc-number">1.22.</span> <span class="toc-text">Cyklus FOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zdroje"><span class="toc-number">1.23.</span> <span class="toc-text">Zdroje:</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&text=02 PL/pgSQL"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&is_video=false&description=02 PL/pgSQL"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=02 PL/pgSQL&body=Check out this article: http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&title=02 PL/pgSQL"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://matkulcik.eu/skola/skola/2017/04/22/PL-pgSQL02/&name=02 PL/pgSQL&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 Róbert Matkulčík
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/skola/">Home</a></li>
         
          <li><a href="/skola/tags/teoria">Teória</a></li>
         
          <li><a href="/skola/tags/priklady">Príklady</a></li>
         
          <li><a href="/skola/archives/">Archív</a></li>
         
          <li><a href="https://github.com/RobqFakulcik/skola">Hosted by GitHub</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <script src="/skola/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/skola/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-72336728-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


</body>
</html>
