<!DOCTYPE html>
<html lang=SK>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Funkcie a triggery v procedurálnom jazyku PL/Python. Programovanie na strane databázového servera PostgreSQL.">
<meta property="og:type" content="article">
<meta property="og:title" content="PL/Python">
<meta property="og:url" content="http://matkulcik.eu/skola/2017/04/23/PL-Python/index.html">
<meta property="og:site_name" content="Procedúry a triggery v PostgreSQL">
<meta property="og:description" content="Funkcie a triggery v procedurálnom jazyku PL/Python. Programovanie na strane databázového servera PostgreSQL.">
<meta property="og:updated_time" content="2017-04-23T01:24:18.560Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PL/Python">
<meta name="twitter:description" content="Funkcie a triggery v procedurálnom jazyku PL/Python. Programovanie na strane databázového servera PostgreSQL.">
    
    
        
          
              <link rel="shortcut icon" href="/skola/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/skola/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/skola/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>PL/Python</title>
    <!-- styles -->
    <link rel="stylesheet" href="/skola/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/skola/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/skola/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/skola/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/skola/lib/jquery/jquery.min.js"></script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/skola/">Home</a></li>
         
          <li><a href="/skola/tags/teoria">Teória</a></li>
         
          <li><a href="/skola/tags/priklady">Príklady</a></li>
         
          <li><a href="/skola/archives/">Archív</a></li>
         
          <li><a href="https://github.com/RobqFakulcik/skola">Hosted by GitHub</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/skola/2017/04/23/PL-pgSQL-Trigger03/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&text=PL/Python"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&is_video=false&description=PL/Python"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PL/Python&body=Check out this article: http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&name=PL/Python&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PL-Python"><span class="toc-number">1.</span> <span class="toc-text">PL/Python</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Instalacia-PL-Python"><span class="toc-number">1.1.</span> <span class="toc-text">Inštalácia PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zakladna-funkcia-v-PL-Python"><span class="toc-number">1.2.</span> <span class="toc-text">Základná funkcia v PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Konverzie-datovych-typov"><span class="toc-number">1.3.</span> <span class="toc-text">Konverzie dátových typov</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pristup-k-databaze-s-PL-Python"><span class="toc-number">1.4.</span> <span class="toc-text">Prístup k databáze s PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PL-Python-funkcie-s-navratovou-hodnotou-RECORD"><span class="toc-number">1.5.</span> <span class="toc-text">PL/Python funkcie s návratovou hodnotou RECORD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zachytenie-a-spracovanie-chyby"><span class="toc-number">1.6.</span> <span class="toc-text">Zachytenie a spracovanie chyby</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Trigger-funkcie-V-PL-Python"><span class="toc-number">1.7.</span> <span class="toc-text">Trigger funkcie V PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Specialne-premenne-vo-funkcii"><span class="toc-number">1.8.</span> <span class="toc-text">Špeciálne premenné vo funkcií</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zdroje"><span class="toc-number">1.9.</span> <span class="toc-text">Zdroje:</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        
    <h1 class="posttitle" itemprop="name headline">
        PL/Python
    </h1>



        <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">
            
            Procedúry a triggery v PostgreSQL
            
        </span>
      </span>
            
    <div class="postdate">
        <time datetime="2017-04-22T23:17:35.000Z" itemprop="datePublished">23-04-2017</time>
    </div>


            
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/skola/tags/teoria/">teoria</a>
    </div>


        </div>
    </header>
    

    <div class="content" itemprop="articleBody">
        <!--Table of content generator-->
        <div id="toc">
            <p>Obsah článku:</p>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PL-Python"><span class="toc-number">1.</span> <span class="toc-text">PL/Python</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Instalacia-PL-Python"><span class="toc-number">1.1.</span> <span class="toc-text">Inštalácia PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zakladna-funkcia-v-PL-Python"><span class="toc-number">1.2.</span> <span class="toc-text">Základná funkcia v PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Konverzie-datovych-typov"><span class="toc-number">1.3.</span> <span class="toc-text">Konverzie dátových typov</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pristup-k-databaze-s-PL-Python"><span class="toc-number">1.4.</span> <span class="toc-text">Prístup k databáze s PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PL-Python-funkcie-s-navratovou-hodnotou-RECORD"><span class="toc-number">1.5.</span> <span class="toc-text">PL/Python funkcie s návratovou hodnotou RECORD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zachytenie-a-spracovanie-chyby"><span class="toc-number">1.6.</span> <span class="toc-text">Zachytenie a spracovanie chyby</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Trigger-funkcie-V-PL-Python"><span class="toc-number">1.7.</span> <span class="toc-text">Trigger funkcie V PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Specialne-premenne-vo-funkcii"><span class="toc-number">1.8.</span> <span class="toc-text">Špeciálne premenné vo funkcií</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zdroje"><span class="toc-number">1.9.</span> <span class="toc-text">Zdroje:</span></a></li></ol></li></ol>
        </div>
        <h2 id="PL-Python"><a href="#PL-Python" class="headerlink" title="PL/Python"></a>PL/Python</h2><p>Ďalším z procedurálnych jazykov je PL/Python. Je to klasický objektový Python, ktorý je možné použiť k vytváraniu uložených procedúr v PostgreSQL. PL/Python je však trochu iný ako PL/pgSQL.  Ide o procedurálny jazyk s nálepkou Untrasted. Jazyk plpythonu je teda označený ako nedôveryhodný, takže ho bežný užívateľ nemôže používať. Buď musí mať super užívateľské práva, alebo sa zmení dôveryhodnosť jazyka na TRUE. Do tejto množiny Untrasted jazykov patrí okrem PL/Python aj PL/Pearl, či PL/TCL a mnoho iných. Programovanie v týchto jazykoch sa riadi pravidlami a zákonitosťami daného jazyka. Z pohľadu začlenenia vytvorených funkcií do DBS PgSQL je pri spustení týchto funkcií volaný vnútorný interpreter, z tohto pohľadu teda pomalšie riešenie než u PL/pgSQL. Na druhej strane je však možné riešiť mnoho úloh v týchto jazykoch rýchlejšie než priamo v DBS alebo v klientskej aplikácií. Argumentom pre rozšírenie funkčnosti o funkcie napísané v týchto jazykoch je možnosť I/O operácií. Tieto jazyky majú oproti Trusted variantám, väčšie možnosti využitia a väčšie právomoci. Dokážu k príkladu vytvárať nové súbory a pristupovať k ním, či napr. otvárať sockety. To samozrejme so sebou prináša aj zvýšenú opatrnosť pri ich vytváraní. Ako nedôveryhodný je PL/Pythonu označený preto, pretože s ním môže nekalý užívateľ narušiť beh serveru (napríklad jeho zaťažením). Možnosti takéhoto jazyka sú ozaj rozsiahle a je v ňom možné pravdepodobne všetko čo v bežnom jazyku Python. Obtiažnejšie je však ladenie takýchto funkcií.1</p>
<p>PL/Python dokonca zvláda aj komunikáciu s okolitým svetom internetu:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> ziskaj_ip_adresu(adresa <span class="built_in">text</span>)</div><div class="line"><span class="keyword">RETURNS</span> inet</div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">	<span class="keyword">import</span> socket</div><div class="line">	<span class="keyword">return</span> socket.gethostbyname(adresa)</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu <span class="keyword">SECURITY</span> DEFINER;</div></pre></td></tr></table></figure></p>
<p>Funkcia vyššie dokáže zistiť IP adresu zvoleného servera, otestujeme ju príkazom:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT ziskaj_ip_adresu('www.postgresql.org');</div><div class="line"></div><div class="line">ziskaj_ip_adresu</div><div class="line">----------------</div><div class="line">217.196.149.50</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>Pričom sa ukázala sila tohto jazyka. Podobná funkcia by v jazyku C, obsahovala desiatky riadkov kódu.<br>Od verzie 9.3 sa pomerne zásadných úprav dočkala podpora uložených procedúr v PL/Python. Tento jazyk je rozšírený zväčša medzi užívateľmi PostGISu (Podpora pre geografické objekty). Zásadným krokom vpred je podpora Pythonu 3. Dvojková rada už podporuje Unicode. Parametre funkcie typu pole sú teraz mapované priamo na pole Pythonu.</p>
<p>Pokiaľ sú všetci užívatelia databázového servera dôveryhodní, je možné zmeniť plpythonu na dôveryhodný:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">-- ako užívateľ postgres</div><div class="line">teoria_tst=# SELECT lanpltrusted FROM pg_language</div><div class="line">WHERE lanname= 'plpythonu';</div><div class="line">lanpltrusted</div><div class="line">--------------</div><div class="line"> f</div><div class="line">(1 row)</div><div class="line"></div><div class="line">teoria_tst=# UPDATE pg_language</div><div class="line">SET lanpltrusted = true WHERE lanname = 'plpythonu';</div><div class="line">UPDATE 1</div><div class="line">-- teraz môže používať PL/Python každý</div></pre></td></tr></table></figure></p>
<p>Inou možnosťou by bolo nastaviť konkrétnemu užívateľovi super užívateľské práva:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-- ako užívatel postgres</div><div class="line">teoria_tst=# ALTER USER peter WITH superuser;</div><div class="line">ALTER ROLE</div><div class="line">-- teraz je peter superuser a môže pracovať s PL/Python</div></pre></td></tr></table></figure></p>
<h3 id="Instalacia-PL-Python"><a href="#Instalacia-PL-Python" class="headerlink" title="Inštalácia PL/Python"></a>Inštalácia PL/Python</h3><p>Často treba nainštalovať samotný PL jazyk na server. Čo v linuxovom systéme OpenSuse, vykonáme príkazom:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># sudo zypper install postgresql-plpython</span></div></pre></td></tr></table></figure></p>
<p>Pre použitie jazyka PL/Python, je potrebné si ho najskôr pre danú databázu „aktivovať“ príkazom CREATE EXTENSION. (Je potrebné na to mať taktiež príslušné práva).<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE EXTENSION plpythonu;</div></pre></td></tr></table></figure></p>
<p>Jazyk však môžeme aktivovať aj príkazom CREATE LANGUAGE.</p>
<p>Úspešnosť aktivácie jazyka je najlepšie otestovať funkciou pre zistenie používanej verzie Pythonu:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> info_verzia()</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">TEXT</span></div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">    	<span class="keyword">import</span> <span class="keyword">sys</span></div><div class="line">    	<span class="keyword">string</span> = sys.version</div><div class="line"> 	<span class="keyword">return</span> <span class="keyword">string</span></div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Výpis verzie používaného Python interpretra:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT info_verzia();</div><div class="line">info_verzia</div><div class="line">---------------</div><div class="line">2.7.12 (default, Jun 28 2016, 06:57:42) [GCC]</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Zakladna-funkcia-v-PL-Python"><a href="#Zakladna-funkcia-v-PL-Python" class="headerlink" title="Základná funkcia v PL/Python"></a>Základná funkcia v PL/Python</h3><p>Rovnako ako v PL/pgSQL aj v PL/Python využívame príkaz CREATE LANGUAGE, pre tvorbu funkcií. Syntax takejto funkcie sa nijako nelíši, samozrejme až na zvolený jazyk funkcie a telo funkcie, v ktorom už nevyužívame syntax SQL, ale syntax programovacieho jazyka Python. Mierne odlišné sú aj údajové typy premenných. Riadime sa syntaxou:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> meno_funkcie(argumenty)</div><div class="line"><span class="keyword">RETURNS</span> navratova_premenna</div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">	  # PL/Python - telo fukcie</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Do tela takejto funkcie je dokonca možné importovať Python moduly - externé knižnice, ktoré však musia byť nainštalované v DB serveri (teoreticky je tu možnosť používať virtualenv). PL/Python ponúka modul plpy, ktorý je vždy automaticky importovaný. Obsahuje užitočné metódy ako je notice a info, ktorá zobrazí INFO hlásenie (klasické pythonovské metódy pre výpis, ako je print, nemožno použiť).<br>Modul plpy a ukážka vo funkcii:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> hello_world()</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">TEXT</span></div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">	plpy.notice(<span class="string">'Funkcia Hello World, sa aktivovala!'</span>)</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Použitie funkcie hello_wrold():<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT hello_world();</div><div class="line">hello_world</div><div class="line">---------------</div><div class="line">Funkcia Hello World, sa aktivovala!</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Konverzie-datovych-typov"><a href="#Konverzie-datovych-typov" class="headerlink" title="Konverzie dátových typov"></a>Konverzie dátových typov</h3><p>Prvou a poslednou činnosťou, ktorá sa vykoná keď je PL funkcia zavolaná, je konverzia hodnôt argumentov medzi PL/python a PostgreSQL. PostgreSQL typy musia byť konvertované na typy, ktoré podporuje PL/python a návratová hodnota musí byť naopak konvertovaná na typ pre PostgreSQL. Niečo také v PL/pgSQL nie je potrebné nakoľko používa rovnaké typy ako PostgreSQL. PL/Python však používa svoje vlastné typy premenných (Integer, string, date…), a tak je potrebné ich konvertovať.</p>
<table>
<thead>
<tr>
<th style="text-align:left">PostgreSQL</th>
<th style="text-align:center">Python 2</th>
<th style="text-align:center">Python 3</th>
<th style="text-align:center">Komentár</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">int2, int4</td>
<td style="text-align:center">int</td>
<td style="text-align:center">int</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">Int8</td>
<td style="text-align:center">long</td>
<td style="text-align:center">int</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">real, double, numeric</td>
<td style="text-align:center">float</td>
<td style="text-align:center">float</td>
<td style="text-align:center">V tomto prípade môže dôjsť k strate presnosti</td>
</tr>
<tr>
<td style="text-align:left">bytea</td>
<td style="text-align:center">str</td>
<td style="text-align:center">bytes</td>
<td style="text-align:center">Žiaden prevod kódovania</td>
</tr>
<tr>
<td style="text-align:left">text, char(), varchar()</td>
<td style="text-align:center">str</td>
<td style="text-align:center">Str</td>
<td style="text-align:center">Vo verzií Python 2 má reťazec kódovanie servera Vo verzií Python 3 je každý reťazec v kódovaní UNICODE.</td>
</tr>
<tr>
<td style="text-align:left">Všetky ostatné typy</td>
<td style="text-align:center">str</td>
<td style="text-align:center">str</td>
</tr>
</tbody>
</table>
<p>Je potrebné aby kódovanie reťazcov bolo rovnaké ako kódovanie v PostgreSQL. Reťazce, ktoré nie sú validné vedú k chybe. Nie všetky chyby kódovania dokáže PostgreSQL zachytiť, a tak sa takéto „chybné“ dáta môžu dostať do výsledkov. Reťazce kódované v UNICODE su konvertované na správne kódovanie automaticky. V Pythone 3 su všetky reťazce UNICODE. Inak povedané, všetko pri 0, False,  prázdnom reťazci alebo slovníku sa v PostgreSQL stane false. Jediná výnimka je pri None, kde sa kontrola vykoná pred ostatnými konverziami. None sa vždy prekonvertujte na NULL a nie na hodnotu typu boolean.</p>
<h3 id="Pristup-k-databaze-s-PL-Python"><a href="#Pristup-k-databaze-s-PL-Python" class="headerlink" title="Prístup k databáze s PL/Python"></a>Prístup k databáze s PL/Python</h3><p>Vďaka modulu plpy a funkcií plpy.execute() je v Pythone jednoduché získať prístup k databáze. Táto funkcia má na svojom vstupe textový dotaz a vracia zoznam slovníkov (list of dictionaries) ako výsledok. Syntax funkcie plpy.execute():<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vysledok = plpy.execute</div><div class="line">(&lt;dotaz text&gt;, [&lt;nepovinny max. pocet riadkov&gt;])</div></pre></td></tr></table></figure></p>
<p>V nasledujúcom príklade bude premenná tst_id slúžiť ako argument vo vnútri funkcie dotaz_select(). Tento argument bude ďalej predaný podfunkcií plpy.execute().<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE OR REPLACE FUNCTION</div><div class="line">dotaz_select(tst_id int)</div><div class="line">RETURNS text</div><div class="line">AS $$</div><div class="line">	vysledok = plpy.execute("""</div><div class="line">		SELECT * FROM tst_tabulka</div><div class="line">		WHERE tst_id = '%s'""" % tst_id)</div><div class="line">	if vysledok.nrows() &gt; 0:</div><div class="line">		return vysledok</div><div class="line">	else:</div><div class="line">		return 'Nenašli sa žiadne riadky s týmto ID'</div><div class="line">$$ LANGUAGE plpythonu;</div></pre></td></tr></table></figure></p>
<p>Spustenie funkcie v psql:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT dotaz_select(1);</div><div class="line">dotaz_select</div><div class="line">-------------------------------------------------------</div><div class="line">&lt;PLyResult status=5 nrows=1</div><div class="line">rows=[&#123;'stat': 'SK', 'tst_meno': 'Rob', 'psc': '02901',</div><div class="line"> 'mesto': 	'Namestovo', 'adresa': 'Vavrecka 240', 	'rok_narodenia': 1990, 'tst_id': 1&#125;]&gt;</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="PL-Python-funkcie-s-navratovou-hodnotou-RECORD"><a href="#PL-Python-funkcie-s-navratovou-hodnotou-RECORD" class="headerlink" title="PL/Python funkcie s návratovou hodnotou RECORD"></a>PL/Python funkcie s návratovou hodnotou RECORD</h3><p>Pre hodnotu návratového typu záznam je možné v PL/Python použiť:</p>
<ul>
<li>Sekvenciu alebo zoznam hodnôt v rovnakom poradí ako pri poliach v návratovom zázname.</li>
<li>Slovník (dictionary) s kľúčmi totožnými ako pri návratovom zázname.</li>
<li>Triedu alebo typovú inštanciu s atribútmi zhodujúcimi sa s poliami v návratovom zázname.</li>
</ul>
<p>Nasledujúce príklady funkcií ukazujú všetky tri možné spôsoby:<br>Prvý za použitia inštancie:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> uzivatel_info(</div><div class="line">	INOUT meno_uzivatela <span class="keyword">name</span>,</div><div class="line">	<span class="keyword">OUT</span> id_uzivatela <span class="keyword">oid</span>,</div><div class="line">	<span class="keyword">OUT</span> super_uzivatel <span class="built_in">boolean</span>)</div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">   	<span class="keyword">class</span> PGUzivatel:</div><div class="line">       		<span class="keyword">def</span> __init__(<span class="keyword">self</span>, meno_uzivatela,</div><div class="line">		 id_uzivatela, super_uzivatel):</div><div class="line">           		self.meno_uzivatela =  meno_uzivatela</div><div class="line">           		self.id_uzivatela =  id_uzivatela</div><div class="line">           		self.super_uzivatel =  super_uzivatel</div><div class="line">   	u = plpy.execute(<span class="string">"""\</span></div><div class="line">       		select usename,usesysid,usesuper</div><div class="line">       		from pg_user</div><div class="line">       		where usename = '%s'""" % meno_uzivatela)[<span class="number">0</span>]</div><div class="line">   			uzivatel = PGUzivatel(u[<span class="string">'usename'</span>], 					u[<span class="string">'usesysid'</span>], u[<span class="string">'usesuper'</span>])</div><div class="line">   	<span class="keyword">return</span> uzivatel</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Jednoduchší spôsob za použitia slovníka:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> uzivatel_info(</div><div class="line">	INOUT meno_uzivatela <span class="keyword">NAME</span>,</div><div class="line">	<span class="keyword">OUT</span>   id_uzivatela   <span class="keyword">OID</span>,</div><div class="line">	<span class="keyword">OUT</span>   super_uzivatel <span class="built_in">BOOLEAN</span>)</div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">u = plpy.execute(<span class="string">"""\</span></div><div class="line">	select usename,usesysid,usesuper</div><div class="line"> 	from pg_user</div><div class="line">	where usename = '%s'""" % meno_uzivatela)[<span class="number">0</span>]</div><div class="line"><span class="keyword">return</span></div><div class="line">	&#123;<span class="string">'meno_uzivatela'</span>:u[<span class="string">'usename'</span>], 						<span class="string">'id_uzivatela'</span>:u[<span class="string">'usesysid'</span>], 						<span class="string">'super_uzivatel'</span>:u[<span class="string">'usesuper'</span>]&#125;</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>A posledný za použitia n-tice (tuple):<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> uzivatel_info(</div><div class="line">	INOUT meno_uzivatela <span class="keyword">NAME</span>,</div><div class="line">	<span class="keyword">OUT</span>   id_uzivatela <span class="keyword">OID</span>,</div><div class="line">	<span class="keyword">OUT</span>   super_uzivatel <span class="built_in">BOOLEAN</span>)</div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">u = plpy.execute(<span class="string">"""\</span></div><div class="line">	select usename,usesysid,usesuper</div><div class="line">    	from pg_user</div><div class="line">    	where usename = '%s'""" % meno_uzivatela)[<span class="number">0</span>]</div><div class="line"><span class="keyword">return</span> (u[<span class="string">'usename'</span>], u[<span class="string">'usesysid'</span>], u[<span class="string">'usesuper'</span>])</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Nula v hranatých zátvorkách na konci príkazu u = plpy.execute(…)[0] vo všetkých troch ukážkach, značí výber prvého riadku výsledku, nakoľko pl.execute aj pre jednoriadkové výsledky vráti zoznam výsledkov. V Pythone je nutné dávať pozor pri kopírovaní kódu. Jednotlivé bloky kódu by mali byť odsadené štyrmi medzerami (PEP-8). Je nutné skontrolovať správnosť odsadenia štandardne vždy, pokiaľ pri vytváraní funkcie dôjde k chybe menom „IndentationError“. Zvyčajne nemá zmysel deklarovať triedu vo vnútri funkcie iba kvôli návratovej hodnote záznam. V prvej funkcií sa nachádza hlavne pre ukážku možností jazyka Python.1</p>
<p>Všetky tieto definované funkcie vracajú rovnaký výsledok:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT * FROM userinfo('postgres');</div><div class="line">meno_uzivatela | id_uzivatela | super_uzivatel</div><div class="line">----------+---------+--------------+--------------</div><div class="line">postgres 	     |	       10 |  t</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h3 id="Zachytenie-a-spracovanie-chyby"><a href="#Zachytenie-a-spracovanie-chyby" class="headerlink" title="Zachytenie a spracovanie chyby"></a>Zachytenie a spracovanie chyby</h3><p>Funkcie, ktoré pristupujú do databázy môžu naraziť na chybu, ktorá môže viesť k prerušeniu a vyvolaniu výnimky. Plpy.execute dokáže vyvolať inštanciu podtriedy plpy.SPIError, ktorá štandardne ukončí chod funkcie. Túto chybu je možné zachytiť rovnako ako všetky ostatné výnimky v Pythone za použitia konštrukcie try/except.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">or</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> skuska_pridania_zaznamu()</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">TEXT</span> <span class="keyword">AS</span> $$</div><div class="line">try:</div><div class="line">    plpy.execute(<span class="string">"INSERT INTO tst_tabulka</span></div><div class="line">VALUES(8, 'Boďka', 1995, 'Istebne 33', 'Istebne', 		'SK', '02113');")</div><div class="line"><span class="keyword">except</span> plpy.SPIError:</div><div class="line">    <span class="keyword">return</span> <span class="string">"Nastala chyba"</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">return</span> <span class="string">"Riadok bol úspešne pridaný."</span></div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Test funkcie:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> skuska_pridania_zaznamu();</div><div class="line">	skuska_pridania_zaznamu</div><div class="line"><span class="comment">-------------------------</span></div><div class="line">	Nastala chyba</div></pre></td></tr></table></figure></p>
<p>Modul plpy ponúka tieto funkcie:</p>
<ul>
<li>plpy.debug( sprava, **kwargs )</li>
<li>plpy.log( sprava, **kwargs )</li>
<li>plpy.info( sprava, **kwargs )</li>
<li>plpy.notice( sprava, **kwargs )</li>
<li>plpy.warning( sprava, **kwargs )</li>
<li>plpy.error( sprava, **kwargs )</li>
<li>plpy.fatal( sprava, **kwargs )</li>
</ul>
<p>Funkcie plpy.error a plpy.fatal slúžia na vyvolanie výnimky v Pythone. Obe funkcie sú takmer totožné a slúžia na upozornenie či informovanie užívateľa databázy. Funkcií zadáme správu ako jej argument. Týchto argumentov môže mať funkcia niekoľko a takýto argument môže obsahovať špeciálne kľúčové slová. Tieto slová iba obohacujú chybovú správu. Je možné použiť následujúce kľúčové slová:</p>
<ul>
<li>detail</li>
<li>hint</li>
<li>sqlstate</li>
<li>schema_name</li>
<li>table_name</li>
<li>column_name</li>
<li>datatype_name</li>
<li>constraint_name</li>
</ul>
<p>Funkcia plpy.error a jej použite vo funkcií:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> vyvolaj_vynimku() <span class="keyword">RETURNS</span> <span class="built_in">void</span> <span class="keyword">AS</span> $$</div><div class="line">plpy.error(<span class="string">"Správa o výnimke"</span>,</div><div class="line">detail=<span class="string">"bližšie informácie"</span>,</div><div class="line">hint=<span class="string">"nápoveda k ladeniu"</span>)</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# SELECT vyvolaj_vynimku();</div><div class="line">ERROR: plpy.Error:  Správa o výnimke</div><div class="line">DETAIL:  bližšie informácie</div><div class="line">HINT:  nápoveda k ladeniu</div><div class="line">CONTEXT: Traceback (most recent call last):</div><div class="line">PL/Python function "vyvolaj_vynimku",</div><div class="line"> line 4, in &lt;module&gt;</div><div class="line">hint="nápoveda k ladeniu")</div><div class="line">PL/Python function "vyvolaj_vynimku"</div></pre></td></tr></table></figure>
<h3 id="Trigger-funkcie-V-PL-Python"><a href="#Trigger-funkcie-V-PL-Python" class="headerlink" title="Trigger funkcie V PL/Python"></a>Trigger funkcie V PL/Python</h3><p>Ako aj ďalšie PL jazyky, tak aj  PL/Python je možné použiť pre zápis trigger funkcií. Deklarácia trigger funkcie je odlišná od bežnej funkcie iba návratovým typom RETURNS TRIGGER. Jednoduchá trigger funkcia, ktorá informuje volajúceho o spustení triggera, môže vyzerať takto:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> oznam_po_zavolani()</div><div class="line"><span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span></div><div class="line"><span class="keyword">AS</span> $$</div><div class="line">plpy.notice(<span class="string">'Trigger bol spustený!'</span>)</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Po vytvorení funkcie, otestujeme trigger na tabuľke tst_tabulka:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# CREATE TRIGGER tabulka_oznam</div><div class="line">BEFORE INSERT ON tabulka</div><div class="line">EXECUTE PROCEDURE oznam_po_zavolani();</div><div class="line">CREATE TRIGGER</div><div class="line">teoria_tst=# INSERT INTO tabulka_tst</div><div class="line">		VALUES</div><div class="line">		(5, 'Deniska', 1995, 'Vavrecka 150',</div><div class="line">		 'Namestovo', 'SK', '02901');</div><div class="line">NOTICE: Trigger bol spustený!</div><div class="line">CONTEXT: PL/Python function "oznam_po_zavolani"</div><div class="line">INSERT 0 1</div></pre></td></tr></table></figure></p>
<p>Samozrejme, predchádzajúca trigger funkcia je trochu zbytočná, ako akýkoľvek trigger, ktorý nevie kedy, a na ktorých dátach bol spustený. Tomuto predchádzajú špeciálne premenné typu slovník (dictionary) nazývané TD. V ktorých sa môžu nachádzať následujúce premenné:<br><code>TD[&quot;event&quot;]</code><br>Meno akcie, ktorá trigger spustila, premenná obsahuje jeden z následujúcich reťazcov: INSERT, UPDATE, DELETE alebo TRUNCATE.<br><code>TD[&quot;when&quot;]</code><br>Čas kedy sa trigger spustil (AFTER/BEFORE/INSTEAD OF)<br><code>TD[&quot;level&quot;]</code><br>ROW alebo STATEMENT<br><code>TD[&quot;old&quot;]</code><br>Obsahuje starý riadok (pred modifikáciou / zmazaním).<br><code>TD[&quot;new&quot;]</code><br>Obsahuje riadok s novou verziou hodnôt (iba pre INSERT a UPDATE pri akcií DELETE je None).<br><code>TD[&quot;name&quot;]</code><br>Meno triggera z príkazu CREATE TRIGGER.<br><code>TD[&quot;table_name&quot;]</code><br>Meno tabuľky, nad ktorou sa trigger spúšťa.<br><code>TD[&quot;relid&quot;]</code><br>Identifikátor objektu OID tabuľky, nad ktorou sa trigger spustil.<br><code>TD[&quot;args&quot;]</code><br>Pokiaľ príkaz CREATE TRIGGER obsahuje argumenty, sú dostupne cez túto premennú. Každý argument má svoj index v slovníku od TD[“args”][0] po TD[“args”][n-1].</p>
<p>Pokiaľ je premenná TD[“when”] (“BEFORE”, “INSTEAD OF”) a TD[“level”] == „ROW“, je možné vrátiť SKIP pre prerušenie akcie. Návratová hodnota None alebo OK ukazuje, že riadok je nemodifikovaný a je v poriadku pokračovať. Hodnota None je v Pythone nastavená implicitne. V prípade že je potrebné modifikovať hodnoty v TD[“new”] a chceme aby PostgreSQL pokračoval s týmito modifikovanými hodnotami, môžeme použiť návratovú premennú MODIFY, ktorá jazyku PL/python naznačí, že dáta sú pozmenené. Čo je možne iba v prípade, ak hodnota premennej  TD[“event”] je INSERT alebo UPDATE, inak bude návratová hodnota ignorovaná.</p>
<h3 id="Specialne-premenne-vo-funkcii"><a href="#Specialne-premenne-vo-funkcii" class="headerlink" title="Špeciálne premenné vo funkcií"></a>Špeciálne premenné vo funkcií</h3><p>Nasledujúca trigger funkcia je užitočná pri vytváraný triggerov, vďaka nej je možné jednoducho a prehľadne vypísať všetky tieto premenné. Čo uvítame hlavne vo fáze ladenia funkcií.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> debug_trigger()</div><div class="line"><span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span></div><div class="line"><span class="keyword">AS</span> $$</div><div class="line"><span class="keyword">import</span> pprint</div><div class="line">pretty _data = pprint.pformat(</div><div class="line">	(</div><div class="line">		(<span class="string">'TD["table_schema"]'</span></div><div class="line">		, TD[<span class="string">"table_schema"</span>] ),</div><div class="line">		(<span class="string">'TD["event"]'</span></div><div class="line">		, TD[<span class="string">"event"</span>] ),</div><div class="line">		(<span class="string">'TD["when"]'</span></div><div class="line">		, TD[<span class="string">"when"</span>] ),</div><div class="line">		(<span class="string">'TD["level"]'</span></div><div class="line">		, TD[<span class="string">"level"</span>] ),</div><div class="line">		(<span class="string">'TD["old"]'</span></div><div class="line">		, TD[<span class="string">"old"</span>] ),</div><div class="line">		(<span class="string">'TD["new"]'</span></div><div class="line">		, TD[<span class="string">"new"</span>] ),</div><div class="line">		(<span class="string">'TD["name"]'</span></div><div class="line">		, TD[<span class="string">"name"</span>] ),</div><div class="line">		(<span class="string">'TD["table_name"]'</span></div><div class="line">		, TD[<span class="string">"table_name"</span>] ),</div><div class="line">		(<span class="string">'TD["relid"]'</span></div><div class="line">		, TD[<span class="string">"relid"</span>] ),</div><div class="line">		(<span class="string">'TD["args"]'</span></div><div class="line">		, TD[<span class="string">"args"</span>] ),</div><div class="line">	)</div><div class="line">)</div><div class="line">plpy.notice(<span class="string">'Obsah premenných:\n'</span> + pretty _data)</div><div class="line">$$ <span class="keyword">LANGUAGE</span> plpythonu;</div></pre></td></tr></table></figure></p>
<p>Trigger nastavíme aby spustil funkciu po DML operácií nad tabuľkou tst_tabulka :<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> test_explore_trigger</div><div class="line"><span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">OR</span> <span class="keyword">UPDATE</span> <span class="keyword">OR</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> tabulka_tst</div><div class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></div><div class="line"><span class="keyword">EXECUTE</span> <span class="keyword">PROCEDURE</span> debug_trigger(<span class="string">'jeden'</span>, <span class="number">2</span>, <span class="literal">null</span>);</div></pre></td></tr></table></figure></p>
<p>Trigger sa aktivuje napríklad akciou INSERT:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">teoria_tst=# INSERT INTO tst_tabulka</div><div class="line">		VALUES (6, 'Pišta', 1990, 'Vavrecka 240', '</div><div class="line">				Vranov nad Topľou', 'SK', '02103');</div><div class="line">NOTICE:  Obsah premenných:</div><div class="line">(('TD["table_schema"]', 'public'),</div><div class="line">('TD["event"]', 'INSERT'),</div><div class="line">('TD["when"]', 'AFTER'),</div><div class="line">('TD["level"]', 'ROW'),</div><div class="line">('TD["old"]', None),</div><div class="line">('TD["new"]',</div><div class="line">&#123;'adresa': 'Pod Topľou', 'mesto': 'Vranov nad Topľov', 	'psc': '02103',</div><div class="line">'rok_narodenia': 1994, 'stat': 'SK', 'tst_id': 7, 	'tst_meno': 'Dano'&#125;),</div><div class="line">('TD["name"]', 'test_explore_trigger'),</div><div class="line">('TD["table_name"]', 'tst_tabulka'),</div><div class="line">('TD["relid"]', '16585'),</div><div class="line">('TD["args"]', ['jeden', '2', 'null']))</div><div class="line">CONTEXT: PL/Python function "debug_trigger"</div><div class="line">INSERT 0 1</div></pre></td></tr></table></figure></p>
<p>Za povšimnutie stojí fakt, že hodnoty premennej TD[“args”], ktorá obsahuje argumenty predané funkcií v príkaze CREATE TRIGGER, sú všetky prevedené na typ reťazec a to dokonca aj NULL. Vždy pri programovaní vlastných zložitejších trigger funkcií pridáme aj túto ladiacu (debug) funkciu.</p>
<h3 id="Zdroje"><a href="#Zdroje" class="headerlink" title="Zdroje:"></a>Zdroje:</h3><p><a href="http://www.sallyx.org/sally/psql/triggery.php?showAdds=0" target="_blank" rel="external">http://www.sallyx.org/sally/psql/triggery.php?showAdds=0</a>;</p>

    </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/skola/">Home</a></li>
         
          <li><a href="/skola/tags/teoria">Teória</a></li>
         
          <li><a href="/skola/tags/priklady">Príklady</a></li>
         
          <li><a href="/skola/archives/">Archív</a></li>
         
          <li><a href="https://github.com/RobqFakulcik/skola">Hosted by GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PL-Python"><span class="toc-number">1.</span> <span class="toc-text">PL/Python</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Instalacia-PL-Python"><span class="toc-number">1.1.</span> <span class="toc-text">Inštalácia PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zakladna-funkcia-v-PL-Python"><span class="toc-number">1.2.</span> <span class="toc-text">Základná funkcia v PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Konverzie-datovych-typov"><span class="toc-number">1.3.</span> <span class="toc-text">Konverzie dátových typov</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pristup-k-databaze-s-PL-Python"><span class="toc-number">1.4.</span> <span class="toc-text">Prístup k databáze s PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PL-Python-funkcie-s-navratovou-hodnotou-RECORD"><span class="toc-number">1.5.</span> <span class="toc-text">PL/Python funkcie s návratovou hodnotou RECORD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zachytenie-a-spracovanie-chyby"><span class="toc-number">1.6.</span> <span class="toc-text">Zachytenie a spracovanie chyby</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Trigger-funkcie-V-PL-Python"><span class="toc-number">1.7.</span> <span class="toc-text">Trigger funkcie V PL/Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Specialne-premenne-vo-funkcii"><span class="toc-number">1.8.</span> <span class="toc-text">Špeciálne premenné vo funkcií</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zdroje"><span class="toc-number">1.9.</span> <span class="toc-text">Zdroje:</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&text=PL/Python"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&is_video=false&description=PL/Python"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PL/Python&body=Check out this article: http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&title=PL/Python"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://matkulcik.eu/skola/skola/2017/04/23/PL-Python/&name=PL/Python&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 Róbert Matkulčík
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/skola/">Home</a></li>
         
          <li><a href="/skola/tags/teoria">Teória</a></li>
         
          <li><a href="/skola/tags/priklady">Príklady</a></li>
         
          <li><a href="/skola/archives/">Archív</a></li>
         
          <li><a href="https://github.com/RobqFakulcik/skola">Hosted by GitHub</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <script src="/skola/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/skola/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-72336728-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


</body>
</html>
